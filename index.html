<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Live Operator Tracker</title>
    
    <!-- PWA Metadata -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="M-Corp Tracker">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .printable-report { 
            background: white; 
            width: 100%;
            max-width: 8.27in; 
            margin: 0 auto;
            color: #1e293b;
            padding: 0.5in;
        }

        .no-break { page-break-inside: avoid; break-inside: avoid; }
        .page-break { page-break-before: always; }
        
        /* Prevent table rows from being cut */
        tr { page-break-inside: avoid; break-inside: avoid; }

        .cert-title { font-family: 'Playfair Display', serif; color: #1e293b; }
        .cert-gold-text { color: #B48C36; }
        .nav-link-active { color: #2563eb; border-bottom: 2px solid #2563eb; }

        /* Login Screen Styles */
        #login-screen {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        .role-btn:hover { transform: translateY(-2px); }

        /* Mobile specific adjustments */
        @media (max-width: 640px) {
            .printable-report { padding: 0.25in; font-size: 0.8em; }
            .glass-card { border-radius: 1rem; }
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            main { padding: 0 !important; margin: 0 !important; }
            .printable-report { box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0.4in; }
        }
    </style>
</head>
<body class="min-h-screen text-slate-800 pb-safe relative">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 text-center">
            <div class="w-20 h-20 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-900/20">
                <i data-lucide="monitor" class="w-10 h-10"></i>
            </div>
            <h1 class="text-2xl font-black text-slate-900 mb-2">M-Commerce Corp</h1>
            <p class="text-slate-500 text-sm font-medium mb-8">Live Operator Tracking System</p>
            
            <div class="space-y-3">
                <button onclick="window.attemptLogin('lead')" class="role-btn w-full p-4 rounded-xl border-2 border-slate-100 hover:border-blue-600 hover:bg-blue-50 transition-all group text-left flex items-center gap-4">
                    <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="shield"></i></div>
                    <div>
                        <p class="font-bold text-slate-900 group-hover:text-blue-700">Live Operator Lead</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Full Admin Access</p>
                    </div>
                </button>
                <button onclick="window.attemptLogin('trainer')" class="role-btn w-full p-4 rounded-xl border-2 border-slate-100 hover:border-purple-600 hover:bg-purple-50 transition-all group text-left flex items-center gap-4">
                    <div class="bg-purple-100 p-2 rounded-lg text-purple-600"><i data-lucide="award"></i></div>
                    <div>
                        <p class="font-bold text-slate-900 group-hover:text-purple-700">Live Operator Trainer</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Full Admin Access</p>
                    </div>
                </button>
                <button onclick="window.attemptLogin('operator')" class="role-btn w-full p-4 rounded-xl border-2 border-slate-100 hover:border-emerald-600 hover:bg-emerald-50 transition-all group text-left flex items-center gap-4">
                    <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600"><i data-lucide="user"></i></div>
                    <div>
                        <p class="font-bold text-slate-900 group-hover:text-emerald-700">Live Operator</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">View & Refresher Only</p>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTENT (Hidden until login) -->
    <div id="app-content" class="hidden">
        <!-- Navigation -->
        <nav class="no-print sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 md:px-6 py-3 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg shadow-blue-200"><i data-lucide="monitor"></i></div>
                    <div>
                        <h1 class="font-bold text-lg md:text-xl tracking-tight text-slate-900 leading-tight">M-Commerce Corporation</h1>
                        <p class="text-[9px] md:text-[10px] text-slate-400 uppercase tracking-widest font-bold hidden sm:block">Live Operator Tracking System</p>
                    </div>
                </div>
            </div>
            
            <!-- Desktop Nav -->
            <div class="hidden md:flex gap-6 h-full items-center">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="admin-only text-sm font-semibold py-1 transition-all border-b-2 border-transparent hover:text-blue-600">Dashboard</button>
                <button onclick="switchView('trainee-list')" id="nav-trainee-list" class="text-sm font-semibold py-1 transition-all border-b-2 border-transparent hover:text-blue-600">Employee List</button>
                <button onclick="switchView('settings')" id="nav-settings" class="admin-only text-sm font-semibold py-1 transition-all border-b-2 border-transparent hover:text-blue-600">Settings</button>
                
                <!-- Role Badge -->
                <div id="role-badge" class="px-3 py-1 bg-slate-100 rounded-full text-[10px] font-black uppercase tracking-widest text-slate-500 border border-slate-200"></div>
                <button onclick="window.logout()" class="text-xs font-bold text-rose-500 hover:text-rose-700">Logout</button>
            </div>

            <!-- Mobile Menu Button -->
            <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg">
                <i data-lucide="menu"></i>
            </button>
        </nav>

        <!-- Mobile Nav Menu (Hidden by default) -->
        <div id="mobile-menu" class="fixed inset-x-0 top-[60px] bg-white border-b border-slate-100 shadow-xl z-40 hidden md:hidden flex-col p-4 space-y-2 no-print">
            <button onclick="switchView('dashboard')" class="admin-only w-full text-left p-3 rounded-xl font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-3"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard</button>
            <button onclick="switchView('trainee-list')" class="w-full text-left p-3 rounded-xl font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-3"><i data-lucide="users" class="w-4 h-4"></i> Employee List</button>
            <button onclick="switchView('settings')" class="admin-only w-full text-left p-3 rounded-xl font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-3"><i data-lucide="settings" class="w-4 h-4"></i> Settings</button>
            <button onclick="window.logout()" class="w-full text-left p-3 rounded-xl font-bold text-rose-600 hover:bg-rose-50 flex items-center gap-3"><i data-lucide="log-out" class="w-4 h-4"></i> Logout</button>
        </div>

        <main class="w-full max-w-7xl mx-auto p-4 md:p-6 pb-24 md:pb-20">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="space-y-6 md:space-y-8">
                <div>
                    <h2 class="text-2xl md:text-3xl font-black text-slate-900">System Dashboard</h2>
                    <p class="text-sm md:text-base text-slate-500">Real-time cloud monitoring of operational performance.</p>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6">
                    <div class="glass-card p-4 md:p-6 rounded-2xl md:rounded-3xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Total</p>
                        <h3 class="text-2xl md:text-3xl font-black text-slate-900" id="dash-total">0</h3>
                    </div>
                    <div class="glass-card p-4 md:p-6 rounded-2xl md:rounded-3xl shadow-sm border-l-4 border-purple-500">
                        <p class="text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Active</p>
                        <h3 class="text-2xl md:text-3xl font-black text-slate-900" id="dash-active">0</h3>
                    </div>
                    <div class="glass-card p-4 md:p-6 rounded-2xl md:rounded-3xl shadow-sm border-l-4 border-emerald-500">
                        <p class="text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Regular</p>
                        <h3 class="text-2xl md:text-3xl font-black text-slate-900" id="dash-regular">0</h3>
                    </div>
                    <div class="glass-card p-4 md:p-6 rounded-2xl md:rounded-3xl shadow-sm border-l-4 border-rose-500">
                        <p class="text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Overdue</p>
                        <h3 class="text-2xl md:text-3xl font-black text-rose-600" id="dash-overdue">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                    <div class="lg:col-span-1 space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="activity" class="text-blue-500 w-5 h-5"></i>
                            <h4 class="font-black text-slate-900 uppercase text-sm tracking-wider">Cloud Activity Log</h4>
                        </div>
                        <div id="activity-feed" class="space-y-3 max-h-[400px] md:max-h-[600px] overflow-y-auto pr-2"></div>
                    </div>

                    <div class="lg:col-span-2 space-y-8">
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="alert-triangle" class="text-rose-500 w-5 h-5"></i>
                                <h4 class="font-black text-slate-900 uppercase text-sm tracking-wider">Overdue Evaluations</h4>
                            </div>
                            <div id="overdue-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="calendar" class="text-emerald-500 w-5 h-5"></i>
                                <h4 class="font-black text-slate-900 uppercase text-sm tracking-wider">Evaluation Queue</h4>
                            </div>
                            <div id="upcoming-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trainee List View -->
            <div id="trainee-list-view" class="hidden space-y-8 md:space-y-12">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black text-slate-900">Personnel Records</h2>
                        <p class="text-sm md:text-base text-slate-500">Cloud-synced employee data management.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                        <div class="relative w-full sm:w-72">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                            <input type="text" id="trainee-search" oninput="renderDashboard()" placeholder="Search..." class="w-full pl-10 pr-4 py-3 md:py-2 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all shadow-sm">
                        </div>
                        <button onclick="showAddTraineeModal()" class="admin-only bg-slate-900 text-white px-6 py-3 md:py-2 rounded-xl text-sm font-semibold flex items-center justify-center gap-2 hover:bg-black transition-all shadow-lg active:scale-95">
                            <i data-lucide="user-plus" class="w-4 h-4"></i> Add Employee
                        </button>
                    </div>
                </div>

                <div id="sections-container" class="space-y-8 md:space-y-12">
                    <section id="sec-trainee">
                        <div class="border-l-4 border-blue-500 pl-4 mb-4 md:mb-6"><h3 class="font-black text-slate-900 uppercase tracking-widest text-xs">Active Trainees</h3></div>
                        <div id="grid-trainee" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                        <div id="empty-trainee" class="hidden text-center py-10 glass-card rounded-3xl border-dashed border-2"><p class="text-slate-400 italic">No records found.</p></div>
                    </section>
                    <section id="sec-probationary">
                        <div class="border-l-4 border-purple-500 pl-4 mb-4 md:mb-6"><h3 class="font-black text-slate-900 uppercase tracking-widest text-xs">Probationary Period</h3></div>
                        <div id="grid-probationary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                        <div id="empty-probationary" class="hidden text-center py-10 glass-card rounded-3xl border-dashed border-2"><p class="text-slate-400 italic">No records found.</p></div>
                    </section>
                    <section id="sec-regular">
                        <div class="border-l-4 border-emerald-500 pl-4 mb-4 md:mb-6"><h3 class="font-black text-slate-900 uppercase tracking-widest text-xs">Regular Staff</h3></div>
                        <div id="grid-regular" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                        <div id="empty-regular" class="hidden text-center py-10 glass-card rounded-3xl border-dashed border-2"><p class="text-slate-400 italic">No records found.</p></div>
                    </section>
                    <section id="sec-terminated">
                        <div class="border-l-4 border-rose-500 pl-4 mb-4 md:mb-6"><h3 class="font-black text-slate-900 uppercase tracking-widest text-xs text-rose-600">Terminated Records</h3></div>
                        <div id="grid-terminated" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 opacity-75"></div>
                        <div id="empty-terminated" class="hidden text-center py-10 glass-card rounded-3xl border-dashed border-2"><p class="text-slate-400 italic">No records found.</p></div>
                    </section>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden space-y-8 max-w-2xl mx-auto">
                <div>
                    <h2 class="text-2xl md:text-3xl font-black text-slate-900">System Settings</h2>
                    <p class="text-sm md:text-base text-slate-500">Manage cloud connectivity and data integrity.</p>
                </div>

                <div class="grid grid-cols-1 gap-6">
                    <!-- Evaluation Settings Card -->
                    <div class="glass-card p-6 md:p-8 rounded-3xl space-y-6 border-l-4 border-l-blue-500">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="file-text"></i></div>
                            <h3 class="text-xl font-bold">Assessment Configuration</h3>
                        </div>
                        <p class="text-sm text-slate-500 leading-relaxed">Customize the questionnaires independently. Switch between Standard/LOL Evaluation and Refresher Evaluation modes.</p>
                        <button onclick="window.openQuestionManager()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-black transition-all shadow-md active:scale-95">
                            <i data-lucide="edit"></i> Manage Assessment Questions
                        </button>
                    </div>

                    <div class="glass-card p-6 md:p-8 rounded-3xl space-y-6">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="database"></i></div>
                            <h3 class="text-xl font-bold">Cloud Persistence</h3>
                        </div>
                        <p class="text-sm text-slate-500 leading-relaxed">Your records are stored in Firebase Firestore. You can still export a manual backup for local archiving.</p>
                        
                        <div class="flex flex-col sm:flex-row gap-4 pt-2">
                            <button onclick="backupData()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-700 transition-all shadow-md active:scale-95">
                                <i data-lucide="download"></i> Backup Data
                            </button>
                            <div class="flex-1 relative">
                                <input type="file" id="restore-input" onchange="restoreData(event)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                <button class="w-full bg-slate-100 text-slate-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-200 transition-all border border-slate-200 shadow-sm active:scale-95">
                                    <i data-lucide="upload"></i> Restore
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card p-6 md:p-8 rounded-3xl border-2 border-rose-50 space-y-6">
                        <div class="flex items-center gap-3 text-rose-600">
                            <div class="p-2 bg-rose-100 rounded-lg"><i data-lucide="alert-octagon"></i></div>
                            <h3 class="text-xl font-bold">Factory Reset</h3>
                        </div>
                        <p class="text-sm text-slate-500 leading-relaxed">Permanently erase all personnel records and activity logs from the Firebase cloud database.</p>
                        <button onclick="showFactoryResetModal()" class="w-full sm:w-auto bg-rose-50 text-rose-600 py-3 px-8 rounded-xl font-bold border-2 border-rose-100 hover:bg-rose-600 hover:text-white transition-all shadow-sm active:scale-95">
                            Wipe Database Records
                        </button>
                    </div>
                </div>
            </div>

            <!-- Detail Views -->
            <div id="eval-view" class="hidden max-w-4xl mx-auto space-y-6">
                <div class="flex items-center justify-between gap-4 sticky top-[68px] z-30 bg-slate-50/90 backdrop-blur-md p-2 rounded-2xl shadow-sm border border-slate-200">
                     <div class="flex items-center gap-4">
                        <button onclick="switchView('trainee-list')" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="arrow-left"></i></button>
                        <h2 class="text-lg md:text-xl font-bold" id="eval-title">Evaluation</h2>
                     </div>
                     <div class="px-4 py-2 bg-slate-900 text-white rounded-xl font-black font-mono text-lg shadow-lg" id="live-score-display">0.0%</div>
                </div>
                
                <div class="glass-card p-6 md:p-8 rounded-3xl shadow-lg space-y-8" id="eval-form-container"></div>
            </div>
            
            <div id="report-view" class="hidden space-y-8">
                <div class="flex items-center gap-4 no-print">
                    <button onclick="switchView('trainee-list')" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="arrow-left"></i></button>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-900">Performance Dossier</h2>
                </div>
                <div id="report-content" class="overflow-x-auto"></div>
            </div>

            <div id="eval-detail-view" class="hidden space-y-8">
                <div class="flex items-center justify-between no-print gap-4">
                    <button id="back-to-report-btn" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="arrow-left"></i></button>
                    <button id="download-eval-pdf" class="bg-slate-900 text-white px-4 md:px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg text-sm active:scale-95"><i data-lucide="download"></i> <span class="hidden sm:inline">Download</span> Report</button>
                </div>
                <div id="eval-detail-content" class="printable-report bg-white rounded-lg shadow-sm"></div>
            </div>

            <div id="endorsement-view" class="hidden space-y-8">
                <div class="flex items-center justify-between no-print gap-4">
                    <button id="back-to-report-from-endorse" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="arrow-left"></i></button>
                    <button id="download-endorse-pdf" class="bg-blue-600 text-white px-4 md:px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg text-sm active:scale-95"><i data-lucide="download"></i> <span class="hidden sm:inline">Download</span> Endorsement</button>
                </div>
                <div id="endorsement-content" class="printable-report bg-white rounded-lg shadow-sm"></div>
            </div>

            <div id="termination-view" class="hidden space-y-8">
                <div class="flex items-center justify-between no-print gap-4">
                    <button id="back-to-report-from-term" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="arrow-left"></i></button>
                    <button id="download-term-pdf" class="bg-rose-600 text-white px-4 md:px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg text-sm active:scale-95"><i data-lucide="download"></i> <span class="hidden sm:inline">Download</span> Notice</button>
                </div>
                <div id="termination-content" class="printable-report bg-white rounded-lg shadow-sm"></div>
            </div>
        </main>
    </div>

    <!-- Modals (unchanged HTML structure, just context) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/60 hidden z-[60] backdrop-blur-sm flex items-center justify-center p-4">
        <!-- Question Editor Modal -->
        <div id="question-editor-modal" class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl p-6 md:p-8 hidden flex flex-col h-[90vh] mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold flex items-center gap-2"><i data-lucide="settings" class="text-blue-600"></i> Assessment Manager</h3>
                <div class="flex items-center gap-3">
                    <button onclick="window.saveEvalStructure(false)" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 shadow-md active:scale-95 flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> Save Changes
                    </button>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 p-2"><i data-lucide="x"></i></button>
                </div>
            </div>
            <!-- Structure Selector -->
            <div class="mb-4">
                <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Editing Mode</label>
                <select id="editor-mode-select" class="w-full p-3 rounded-xl border-2 border-slate-200 text-sm font-bold outline-none focus:border-blue-500 bg-slate-50 text-slate-800" onchange="window.switchEditorMode()">
                    <option value="standard">Standard & LOL Evaluation (Grades 1-5)</option>
                    <option value="refresher">Refresher Evaluation (Multiple Choice)</option>
                </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 flex-grow overflow-hidden">
                <!-- Sidebar -->
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex flex-col gap-4">
                     <!-- Category Control -->
                     <div>
                         <label class="block text-xs font-bold uppercase text-slate-400 mb-2">Category</label>
                         <div class="flex gap-2 mb-2">
                             <select id="editor-category-select" class="w-full p-2 rounded-xl border border-slate-200 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-white" onchange="window.renderEditorSections()"></select>
                             <button onclick="window.renameCategory()" class="p-2 bg-white border border-slate-200 rounded-lg text-blue-600 hover:bg-blue-50"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                             <button onclick="window.deleteCategory()" class="p-2 bg-white border border-slate-200 rounded-lg text-rose-500 hover:bg-rose-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                         </div>
                         <button onclick="window.addCategory()" class="w-full py-2 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200 flex items-center justify-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Add Category</button>
                     </div>
                     <!-- Section Control -->
                     <div>
                         <label class="block text-xs font-bold uppercase text-slate-400 mb-2">Section</label>
                         <div class="flex gap-2 mb-2">
                            <select id="editor-section-select" class="w-full p-2 rounded-xl border border-slate-200 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-white" onchange="window.renderEditorQuestions()"></select>
                            <button onclick="window.renameSection()" class="p-2 bg-white border border-slate-200 rounded-lg text-blue-600 hover:bg-blue-50"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="window.deleteSection()" class="p-2 bg-white border border-slate-200 rounded-lg text-rose-500 hover:bg-rose-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                         </div>
                         <button onclick="window.addSection()" class="w-full py-2 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200 flex items-center justify-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Add Section</button>
                     </div>
                     <div class="mt-auto pt-4 border-t border-slate-200">
                         <button onclick="window.addQuestion()" class="w-full py-3 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 flex items-center justify-center gap-2 shadow-md active:scale-95"><i data-lucide="plus-circle" class="w-4 h-4"></i> Add Question</button>
                     </div>
                </div>
                <!-- Main Content -->
                <div class="md:col-span-2 overflow-y-auto pr-2 space-y-4" id="editor-questions-list">
                    <p class="text-center text-slate-400 italic mt-10">Select a category and section to edit questions.</p>
                </div>
            </div>
        </div>

        <!-- Security Reset Modal -->
        <div id="factory-reset-modal" class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 md:p-8 hidden text-center border-4 border-rose-100 mx-4">
            <div class="w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-octagon" class="w-8 h-8"></i></div>
            <h3 class="text-xl font-bold mb-2">Security Verification</h3>
            <p class="text-sm text-slate-500 mb-6">Erasing all database records. Type <span class="font-black text-rose-600">RESET</span> to confirm.</p>
            <input type="text" id="reset-verify-input" placeholder="..." class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-rose-500 text-center font-bold mb-6">
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all active:scale-95">Cancel</button>
                <button id="confirm-reset-btn" class="flex-1 py-3 bg-rose-600 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95">Execute Reset</button>
            </div>
        </div>
        
        <!-- Add Personnel Modal -->
        <div id="add-trainee-modal" class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 md:p-8 hidden mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" id="trainee-modal-title">Personnel Entry</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 p-2"><i data-lucide="x"></i></button>
            </div>
            <form id="add-trainee-form" class="space-y-4">
                <input type="hidden" name="firebaseId">
                <input type="hidden" name="id">
                <div><label class="block text-sm font-semibold mb-1 text-slate-700">Full Name</label><input type="text" name="name" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label class="block text-sm font-semibold mb-1 text-slate-700">Hire Date</label><input type="date" name="hireDate" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div>
                    <label class="block text-sm font-semibold mb-1 text-slate-700">Status</label>
                    <select name="status" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="Trainee">Trainee</option>
                        <option value="Probationary">Probationary</option>
                        <option value="Regular">Regular</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold hover:bg-black transition-all shadow-lg mt-4 active:scale-95">Save to Database</button>
            </form>
        </div>

        <!-- Termination Modal -->
        <div id="terminate-modal" class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 md:p-8 hidden text-center mx-4 max-h-[90vh] overflow-y-auto">
            <div class="w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="user-x" class="w-8 h-8"></i></div>
            <h3 class="text-xl font-bold mb-2">Grounds for Termination</h3>
            <textarea id="terminate-reason" class="w-full p-4 border border-slate-200 rounded-xl h-32 text-sm focus:ring-2 focus:ring-rose-500 outline-none mb-6" placeholder="Document specific administrative grounds..."></textarea>
            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all active:scale-95">Cancel</button>
                <button id="confirm-terminate-btn" class="flex-1 py-3 bg-rose-600 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95">Finalize</button>
            </div>
        </div>

        <!-- Celebration Modal -->
        <div id="congrats-modal" class="bg-white w-full max-w-5xl rounded-[30px] md:rounded-[40px] shadow-2xl p-0 overflow-hidden hidden mx-4 max-h-[90vh] overflow-y-auto">
            <!-- Landscape Wrapper: A4 Landscape is approx 11.7 x 8.3 in -->
            <div id="cert-pdf-wrapper" class="bg-white flex items-center justify-center p-8" style="width: 11.69in; height: 8.27in; margin: 0 auto;">
                <!-- Frame Construction using Standard Borders for Maximum PDF Compatibility -->
                <div class="w-full h-full border-[20px] border-[#B48C36] p-2 flex flex-col box-border">
                    <div class="w-full h-full border-[8px] border-[#D4AF37] flex flex-col justify-center items-center p-8 text-center space-y-6 relative bg-white box-border">
                        <!-- Decorative Corners -->
                        <div class="absolute top-2 left-2 w-16 h-16 border-t-4 border-l-4 border-[#B48C36]"></div>
                        <div class="absolute top-2 right-2 w-16 h-16 border-t-4 border-r-4 border-[#B48C36]"></div>
                        <div class="absolute bottom-2 left-2 w-16 h-16 border-b-4 border-l-4 border-[#B48C36]"></div>
                        <div class="absolute bottom-2 right-2 w-16 h-16 border-b-4 border-r-4 border-[#B48C36]"></div>
                        <div class="space-y-3 z-10">
                            <h4 class="text-blue-900 font-black uppercase tracking-[0.4em] text-sm">M-Commerce Corporation</h4>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Operation Department</p>
                        </div>
                        <div class="space-y-4 z-10">
                            <h2 class="cert-title text-6xl font-black text-slate-900">Certificate of Promotion</h2>
                            <p class="text-slate-500 font-medium italic text-lg">This honor is officially awarded to</p>
                        </div>
                        <div class="space-y-4 z-10">
                            <h3 class="text-6xl font-black text-[#B48C36] underline underline-offset-8 decoration-slate-200" id="cert-name"></h3>
                            <div class="space-y-1">
                                <p class="text-slate-500 text-lg">For demonstrating exceptional technical mastery and professionalism,</p>
                                <p class="text-slate-500 text-lg">qualifying for advancement to the role of</p>
                            </div>
                            <p class="text-4xl font-black text-blue-900 uppercase tracking-tighter mt-4" id="cert-status"></p>
                        </div>
                        <div class="pt-12 w-full max-w-4xl grid grid-cols-3 gap-12 items-end z-10">
                            <div class="border-t-2 border-slate-900 pt-4"><p class="text-[10px] font-black uppercase text-slate-400 mb-1">Date of Award</p><p class="text-sm font-bold text-slate-900" id="cert-date"></p></div>
                            <div class="flex justify-center items-center opacity-30"><i data-lucide="award" class="text-blue-900 w-16 h-16"></i></div>
                            <div class="border-t-2 border-slate-900 pt-4"><p class="text-[10px] font-black uppercase text-slate-400 mb-1">Authorization</p><p class="text-sm font-bold text-slate-900">Live Operator Trainer</p></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 md:p-8 bg-slate-50 flex flex-col md:flex-row justify-end gap-3 md:gap-4 border-t border-slate-100">
                <button onclick="closeModal()" class="w-full md:w-auto px-8 py-3 text-slate-500 font-bold hover:bg-white rounded-xl transition-all active:scale-95">Close</button>
                <button id="download-cert-pdf" class="w-full md:w-auto px-8 py-3 bg-blue-900 text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-xl active:scale-95"><i data-lucide="download"></i> Download Certificate (Landscape)</button>
            </div>
        </div>
    </div>

    <!-- NEW PROMPT OVERLAY (Updated z-index to 110 to show over login screen) -->
    <div id="prompt-overlay" class="fixed inset-0 bg-slate-900/60 hidden z-[110] backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 md:p-8 text-center mx-4">
            <h3 class="text-xl font-bold mb-2" id="prompt-modal-title">Input Required</h3>
            <p class="text-sm text-slate-500 mb-4" id="prompt-modal-message">Please enter a value:</p>
            <input type="text" id="prompt-input" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500 font-bold mb-6">
            <div class="flex gap-3">
                <button onclick="closePromptModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all active:scale-95">Cancel</button>
                <button id="prompt-confirm-btn" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95">Save</button>
            </div>
        </div>
    </div>

    <!-- INDEPENDENT CONFIRM OVERLAY -->
    <div id="confirm-overlay" class="fixed inset-0 bg-slate-900/60 hidden z-[70] backdrop-blur-sm flex items-center justify-center p-4">
        <div id="confirm-modal" class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 md:p-8 text-center mx-4">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="help-circle" class="w-8 h-8"></i></div>
            <h3 class="text-xl font-bold mb-2" id="confirm-modal-title">Confirm</h3>
            <p class="text-sm text-slate-500 mb-8 px-2" id="confirm-modal-message">Are you sure?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all active:scale-95">Cancel</button>
                <button id="generic-confirm-btn" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95">Proceed</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, updateDoc, deleteDoc, collection, query, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Shared Global State
        window.employees = [];
        window.activityLog = [];
        window.currentEvalType = null;
        window.currentUserRole = null; // 'lead', 'trainer', 'operator'
        let currentEvalEmployeeId = null;
        let currentEditingEvalId = null; 

        // --- Core UI Logic ---
        
        // LOGIN LOGIC
        window.attemptLogin = function(role) {
            // Sanitize input just in case
            const r = role ? role.trim().toLowerCase() : '';
            
            if (r === 'operator') {
                window.login(r);
                return;
            }

            const passwords = {
                'lead': 'lead123',
                'trainer': 'trainer123'
            };

            const roleName = r === 'lead' ? 'Live Operator Lead' : 'Live Operator Trainer';

            window.showPromptModal(
                "Admin Access Required", 
                `Enter password for ${roleName}:`, 
                "", 
                (password) => {
                    if (password === passwords[r]) {
                        window.login(r);
                    } else {
                        window.showNotification("Access Denied: Incorrect Password");
                    }
                },
                "password" 
            );
        }

        window.login = function(role) {
            window.currentUserRole = role;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            // Set Badge
            const badge = document.getElementById('role-badge');
            if (role === 'lead') badge.innerText = "Lead";
            else if (role === 'trainer') badge.innerText = "Trainer";
            else badge.innerText = "Operator";

            // If operator, force default view to employee list
            if (role === 'operator') {
                window.switchView('trainee-list');
            } else {
                window.switchView('dashboard');
            }
            renderDashboard(); // Re-render to apply permissions
        }

        window.logout = function() {
            location.reload(); // Simple reload to reset state
        }

        // Apply Permission Visibility
        function applyPermissions() {
            const isAdmin = window.currentUserRole === 'lead' || window.currentUserRole === 'trainer';
            
            // Toggle all elements with 'admin-only' class
            document.querySelectorAll('.admin-only').forEach(el => {
                if (isAdmin) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }

        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('flex');
        }

        window.showConfirmModal = function(title, message, onConfirm) {
            document.getElementById('confirm-modal-title').innerText = title;
            document.getElementById('confirm-modal-message').innerText = message;
            document.getElementById('confirm-overlay').classList.remove('hidden');
            document.getElementById('generic-confirm-btn').onclick = () => { onConfirm(); closeConfirmModal(); };
            lucide.createIcons();
        }

        window.closeConfirmModal = function() { document.getElementById('confirm-overlay').classList.add('hidden'); }

        window.showPromptModal = function(title, message, initialValue, onConfirm, inputType = 'text') {
            document.getElementById('prompt-modal-title').innerText = title;
            document.getElementById('prompt-modal-message').innerText = message;
            const input = document.getElementById('prompt-input');
            input.type = inputType; // Set input type (text or password)
            input.value = initialValue || '';
            document.getElementById('prompt-overlay').classList.remove('hidden');
            input.focus();
            const confirmBtn = document.getElementById('prompt-confirm-btn');
            // Remove old listeners to prevent stacking
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            newBtn.onclick = () => {
                const val = document.getElementById('prompt-input').value.trim();
                if(val) { onConfirm(val); closePromptModal(); }
            };
            // Add Enter key support
            input.onkeyup = (e) => {
                if(e.key === 'Enter') newBtn.click();
            };
        }

        window.closePromptModal = function() { 
            document.getElementById('prompt-overlay').classList.add('hidden'); 
            // Reset input type back to text
            document.getElementById('prompt-input').type = 'text';
        }

        window.showFactoryResetModal = function() {
            document.getElementById('reset-verify-input').value = '';
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('factory-reset-modal').classList.remove('hidden');
            document.getElementById('confirm-reset-btn').onclick = () => {
                const keyword = document.getElementById('reset-verify-input').value.trim();
                if (keyword === 'RESET') { window.factoryResetDB().then(() => { showNotification("Cloud System Reset."); closeModal(); }); } 
                else { showNotification("Invalid Security Key."); }
            };
            lucide.createIcons();
        }

        window.switchView = function(view) {
            // Permission check for Nav
            if (window.currentUserRole === 'operator' && (view === 'dashboard' || view === 'settings')) {
                return; // Prevent access
            }

            document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`${view}-view`);
            if (target) target.classList.remove('hidden');
            document.querySelectorAll('nav button[id^="nav-"]').forEach(btn => btn.classList.remove('nav-link-active'));
            const navBtn = document.getElementById(`nav-${view}`);
            if (navBtn) navBtn.classList.add('nav-link-active');
            document.getElementById('mobile-menu').classList.add('hidden');
            document.getElementById('mobile-menu').classList.remove('flex');
            
            renderDashboard(); 
            lucide.createIcons(); 
            window.scrollTo(0,0);
        }

        window.closeModal = function() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.querySelectorAll('#modal-backdrop > div').forEach(el => el.classList.add('hidden'));
        }

        window.showAddTraineeModal = function() {
            document.getElementById('trainee-modal-title').innerText = 'Personnel Registration';
            const form = document.getElementById('add-trainee-form');
            form.reset();
            form.querySelector('input[name="firebaseId"]').value = '';
            form.querySelector('input[name="id"]').value = '';
            form.querySelector('select[name="status"]').value = 'Trainee'; 
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('add-trainee-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        window.showEditModal = function(id) {
            const emp = window.employees.find(e => e.id == id);
            if (!emp) return;
            document.getElementById('trainee-modal-title').innerText = 'Update Personnel File';
            const form = document.getElementById('add-trainee-form');
            form.querySelector('input[name="firebaseId"]').value = emp.firebaseId || '';
            form.querySelector('input[name="id"]').value = emp.id;
            form.querySelector('input[name="name"]').value = emp.name;
            form.querySelector('input[name="hireDate"]').value = emp.hireDate;
            form.querySelector('select[name="status"]').value = emp.status;
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('add-trainee-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        window.confirmDelete = function(id) {
            const emp = window.employees.find(e => e.id == id);
            if (!emp) return;
            showConfirmModal("Delete Dossier", `Permanently erase ${emp.name} from the cloud database?`, () => {
                window.deleteEmployee(emp.firebaseId).then(() => { window.logActivity('delete', 'Record deleted', emp.name); });
            });
        }

        window.showCongrats = function(emp) {
            document.getElementById('cert-name').innerText = emp.name;
            document.getElementById('cert-status').innerText = emp.status;
            if (emp.achievements && emp.achievements.length > 0) { document.getElementById('cert-date').innerText = formatDateStandard(emp.achievements[emp.achievements.length - 1].date); } 
            else { document.getElementById('cert-date').innerText = formatDateStandard(new Date()); }
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('congrats-modal').classList.remove('hidden');
            document.getElementById('download-cert-pdf').onclick = () => window.downloadCertificatePDF(`${emp.name}_Certificate.pdf`);
            lucide.createIcons();
        }

        window.formatDateStandard = function(dateInput) {
            if (!dateInput || dateInput === 'Pending') return 'Pending';
            if (typeof dateInput === 'string' && dateInput.match(/^\d{4}-\d{2}-\d{2}$/)) {
                 const parts = dateInput.split('-');
                 const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                 return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            }
            const d = new Date(dateInput);
            if (isNaN(d.getTime())) return dateInput; 
            return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        window.calculateNextDueDate = function(emp) {
             if (emp.status === 'Terminated') return 'N/A';
             const parts = emp.hireDate.split('-');
             const hireDay = parseInt(parts[2]);
             const hireYear = parseInt(parts[0]);
             if (emp.status === 'Regular') {
                 const today = new Date();
                 const currentYear = today.getFullYear();
                 const refreshers = (emp.evaluations || []).filter(e => e.type === 'Refresher').sort((a,b) => new Date(a.date) - new Date(b.date));
                 const lastRefresher = refreshers.length ? refreshers[refreshers.length-1] : null;
                 if (!lastRefresher) {
                     let targetYear = currentYear;
                     const target = new Date(targetYear, 1, hireDay); 
                     return formatDateStandard(target);
                 } else {
                     const lastDate = new Date(lastRefresher.date);
                     let nextYear = lastDate.getFullYear();
                     let nextMonth = lastDate.getMonth() + 1;
                     if (nextMonth > 11) { nextMonth = 0; nextYear++; }
                     if (nextMonth === 0) { nextMonth = 1; }
                     const nextDate = new Date(nextYear, nextMonth, hireDay);
                     return formatDateStandard(nextDate);
                 }
             } else {
                 const d = new Date(hireYear, parseInt(parts[1]) - 1, hireDay);
                 d.setMonth(d.getMonth() + (emp.evaluations || []).length + 1);
                 return formatDateStandard(d);
             }
        }

        window.calculateNextDate = function(hireDate, monthsToAddAdjusted) {
             if (!hireDate) return formatDateStandard(new Date());
             const parts = hireDate.split('-');
             const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
             d.setMonth(d.getMonth() + monthsToAddAdjusted + 1);
             return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        window.renderDashboard = function() {
            // Apply permission hiding on every render
            applyPermissions();

            const today = new Date(); today.setHours(0,0,0,0);
            const searchInput = document.getElementById('trainee-search');
            const queryText = searchInput ? searchInput.value.toLowerCase() : '';
            const employees = window.employees || [];
            let overdueCount = 0, overdueItems = [], upcomingItems = [];
            const filtered = employees.filter(e => e.name.toLowerCase().includes(queryText));

            employees.forEach(emp => {
                if (emp.status === 'Terminated') return;
                const nextStr = calculateNextDueDate(emp);
                if (nextStr === 'N/A') return;
                const nextDate = new Date(nextStr);
                if (nextDate < today) {
                    overdueCount++;
                    overdueItems.push({ id: emp.id, name: emp.name, date: nextStr, days: Math.ceil(Math.abs(today - nextDate) / 86400000), status: emp.status });
                } else {
                    upcomingItems.push({ id: emp.id, name: emp.name, date: nextStr, status: emp.status });
                }
            });

            const stats = { 'dash-total': employees.length, 'dash-active': employees.filter(e => e.status !== 'Terminated' && e.status !== 'Regular').length, 'dash-regular': employees.filter(e => e.status === 'Regular').length, 'dash-overdue': overdueCount };
            for (const [id, val] of Object.entries(stats)) { const el = document.getElementById(id); if (el) el.innerText = val; }

            const ovList = document.getElementById('overdue-list');
            if (ovList) ovList.innerHTML = overdueItems.length ? overdueItems.map(item => `<div onclick="viewReport(${item.id})" class="cursor-pointer hover:bg-slate-50 transition-colors glass-card p-4 rounded-2xl border-l-4 border-l-rose-500 flex justify-between items-center"><div><p class="font-black text-sm text-slate-900 truncate max-w-[120px]">${item.name}</p><p class="text-[9px] font-bold text-slate-400 uppercase">${item.status}</p></div><div class="text-right"><p class="text-[9px] font-black text-rose-600 uppercase">Late ${item.days}d</p><p class="text-[10px] font-bold text-slate-500">${item.date}</p></div></div>`).join('') : '<div class="col-span-full py-10 glass-card rounded-3xl border-dashed border-2 text-center text-xs text-slate-400 uppercase tracking-widest">No overdue assessments.</div>';

            const upList = document.getElementById('upcoming-list');
            if (upList) upList.innerHTML = upcomingItems.length ? upcomingItems.sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0,4).map(item => `<div onclick="viewReport(${item.id})" class="cursor-pointer hover:bg-slate-50 transition-colors glass-card p-4 rounded-2xl border-l-4 border-l-blue-500 flex justify-between items-center"><div><p class="font-black text-sm text-slate-900 truncate max-w-[120px]">${item.name}</p><p class="text-[9px] font-bold text-slate-400 uppercase">${item.status}</p></div><div class="text-right"><p class="text-[9px] font-black text-blue-600 uppercase">Scheduled</p><p class="text-[10px] font-bold text-slate-500">${item.date}</p></div></div>`).join('') : '<div class="col-span-full py-10 glass-card rounded-3xl border-dashed border-2 text-center text-xs text-slate-400">Empty queue.</div>';

            const actFeed = document.getElementById('activity-feed');
            if (actFeed) actFeed.innerHTML = window.activityLog.slice(0,15).map(l => `<div class="p-3 bg-white border rounded-2xl flex items-start gap-3"><div class="flex-grow"><p class="text-[10px] font-black text-slate-800 uppercase truncate max-w-[150px]">${l.empName}</p><p class="text-[9px] text-slate-500 truncate max-w-[180px]">${l.message}</p></div><p class="text-[8px] text-slate-400 font-bold whitespace-nowrap">${l.date.split(',')[0]}</p></div>`).join('') || '<p class="text-xs italic text-slate-400">No logs found.</p>';

            const gridIds = { 'Trainee': 'grid-trainee', 'Probationary': 'grid-probationary', 'Regular': 'grid-regular', 'Terminated': 'grid-terminated' };
            Object.values(gridIds).forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = ''; });
            
            filtered.forEach(emp => {
                const grid = document.getElementById(gridIds[emp.status]);
                if(!grid) return;
                const phaseEvals = emp.evaluations.slice(emp.phaseStartIdx || 0);
                const isCycleComplete = phaseEvals.length >= (emp.phaseLimit || 3);
                const nextEvalDate = calculateNextDueDate(emp);
                const probAch = emp.achievements?.find(a => a.type === 'Probationary');
                const regAch = emp.achievements?.find(a => a.type === 'Regular');
                const probDate = probAch ? formatDateStandard(probAch.date) : 'Pending';
                const regDate = regAch ? formatDateStandard(regAch.date) : 'Pending';

                const card = document.createElement('div');
                card.className = 'glass-card p-6 rounded-3xl shadow-sm border-t-8 flex flex-col relative group cursor-pointer transition-transform active:scale-[0.99] ' + (emp.status === 'Trainee' ? 'border-t-blue-500' : emp.status === 'Probationary' ? 'border-t-purple-500' : emp.status === 'Regular' ? 'border-t-emerald-500' : 'border-t-rose-500');
                card.onclick = (e) => {
                    if(e.target.closest('button')) return;
                    viewReport(emp.id);
                };

                const isAdmin = window.currentUserRole === 'lead' || window.currentUserRole === 'trainer';
                const editButtons = isAdmin ? `
                    <div class="flex gap-1 no-print">
                        <button onclick="showEditModal(${emp.id})" class="p-2 hover:bg-blue-50 text-blue-500 rounded-lg transition-all active:scale-95"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="confirmDelete(${emp.id})" class="p-2 hover:bg-rose-50 text-rose-500 rounded-lg transition-all active:scale-95"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                ` : '';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div class="max-w-[70%]">
                            <h3 class="font-black text-lg text-slate-900 break-words group-hover:text-blue-600 transition-colors">${emp.name}</h3>
                            <div class="space-y-1 mt-2">
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Hired: <span class="text-slate-600">${formatDateStandard(emp.hireDate)}</span></p>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Probation: <span class="${probAch ? 'text-purple-600' : 'text-slate-300'}">${probDate}</span></p>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Regular: <span class="${regAch ? 'text-emerald-600' : 'text-slate-300'}">${regDate}</span></p>
                            </div>
                            ${emp.status !== 'Terminated' ? `<p class="text-[10px] text-blue-600 font-bold uppercase tracking-widest mt-3 flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> Next: ${nextEvalDate}</p>` : ''}
                        </div>
                        <div class="flex flex-col items-end gap-2">
                             <span class="px-2 py-0.5 rounded-full text-[8px] font-black uppercase tracking-widest ${getStatusClass(emp.status)}">${emp.status}</span>
                             ${editButtons}
                        </div>
                    </div>
                    <div class="space-y-4 flex-grow">
                        ${emp.status !== 'Regular' && emp.status !== 'Terminated' ? `
                            <div class="space-y-1">
                                <div class="flex justify-between text-[10px] font-black uppercase"><span class="text-slate-400">Progress</span><span class="text-blue-600">${phaseEvals.length}/${emp.phaseLimit || 3} Mos</span></div>
                                <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-blue-600 transition-all duration-500" style="width: ${(phaseEvals.length/(emp.phaseLimit||3))*100}%"></div></div>
                            </div>
                        ` : emp.status === 'Regular' ? `
                            <div class="bg-emerald-50 border border-emerald-100 p-2 rounded-xl mt-2">
                                <p class="text-[9px] font-bold text-emerald-600 text-center uppercase">Refresher Cycle Active</p>
                            </div>
                        ` : ''}
                        ${isCycleComplete && emp.status !== 'Regular' && emp.status !== 'Terminated' ? `
                            <div class="bg-blue-50 border border-blue-100 p-3 rounded-2xl">
                                <p class="text-[9px] font-black text-blue-600 uppercase mb-2 text-center">Cycle Finished (Avg: ${phaseEvals.length ? (phaseEvals.reduce((a,c) => a+parseFloat(c.score),0)/phaseEvals.length).toFixed(1) : 0}%)</p>
                                <p class="text-[8px] text-slate-400 text-center italic">Action required in Dossier</p>
                            </div>
                        ` : emp.status === 'Terminated' ? `<p class="text-[9px] italic text-rose-800 line-clamp-2 uppercase font-bold tracking-tight bg-rose-50 p-2 rounded-xl border border-rose-100">Notice: ${emp.terminationReason}</p>` : ''}
                    </div>
                    <div class="mt-6 flex justify-end">
                         <span class="text-[10px] font-black uppercase text-slate-300 group-hover:text-blue-400 flex items-center gap-1 transition-colors">View Dossier <i data-lucide="arrow-right" class="w-3 h-3"></i></span>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- DUAL CONFIGURATION STRUCTURE (Previous logic maintained) ---
        const BASE_QUESTIONS = [
            { category: "OBS Setup & Troubleshooting", sections: [{ title: "OBS Basic", questions: [
                { q: "Parts of Livescene", ans: "Basic: Header, Sticker, Podium, Background. Advance: Header/Brand Logo, Sub-Header, Frame, Stickers (UL/UR/LL/LR), Podium.", refresher: { options: ["Header/Brand Logo...", "Webcam...", "Header...", "Scene..."], correct: 0 } },
                { q: "Mostly Used Source in OBS", ans: "Basic: Image, Media Source, Video Capture. Advance: Image, Media Source, Video Capture, Color Source, Text Source.", refresher: { options: ["Display Capture...", "Image, Media Source...", "Text...", "Audio Input..."], correct: 1 } },
                { q: "Proper & Improper Microphone Setup", ans: "Proper: Input Audio Source Directly on OBS Settings. Improper: Input in every Scene.", refresher: { options: ["Use Desktop Audio...", "Input audio source...", "Route audio...", "Use Monitor Output..."], correct: 1 } }
            ]}, { title: "OBS Settings", questions: [
                { q: "OBS Canvas Settings", ans: "Basic: 1080x1920. Advance: 1080x1920 & Aspect Ratio 9:16.", refresher: { options: ["1920x1080", "1280x720", "1080x1920", "720x1280"], correct: 2 } },
                { q: "OBS Encoder", ans: "Nvidia NVEC H.264", refresher: { options: ["Software", "Nvidia NVEC H264", "QuickSync", "AOM AV1"], correct: 1 } },
                { q: "OBS Rate Control", ans: "CBR (Constant) & VBR (Variable).", refresher: { options: ["CQP & Lossless", "CBR & VBR", "VBR & CQP", "CBR & Lossless"], correct: 1 } },
                { q: "Use of CBR & VBR", ans: "CBR: Forces specific bitrate (good for fast net, lags if drops). VBR: Adapts to min/max limits (good for slow net).", refresher: { options: ["CBR for slow...", "CBR forces bitrate...", "Both perform same", "VBR for recording"], correct: 1 } }
            ]}, { title: "OBS Source Settings", questions: [
                { q: "Video Capture Device", ans: "Disable buffering. Audio output mode: DirectSound.", refresher: { options: ["Enable Buffering...", "Disable Buffering...", "Auto-detect...", "Buffering On..."], correct: 1 } },
                { q: "Media Source", ans: "Check all except 'Close File when Inactive'.", refresher: { options: ["Check 'Close File'...", "Uncheck 'Loop'...", "Check all except...", "Hardware decoding only"], correct: 2 } }
            ]}, { title: "OBS Chroma Key", questions: [
                { q: "Similarity", ans: "Controls how close pixels must be to the key color to be removed.", refresher: { options: ["Edge softness", "Pixel closeness to key color", "Green spill", "Brightness"], correct: 1 } },
                { q: "Smoothness", ans: "Softens edges and removes jagged edges.", refresher: { options: ["Softens edges...", "Selects color", "Opacity", "Contrast"], correct: 0 } },
                { q: "Key Color Spill", ans: "Removes green outlines from edges.", refresher: { options: ["Sharpen image", "Removes green outlines", "Change BG color", "Saturation"], correct: 1 } }
            ]}, { title: "OBS Chroma Key Troubleshooting", questions: [
                { q: "Default Settings", ans: "Similarity: Depends on color. Smoothness: 80. Spill: 50.", refresher: { options: ["All 100", "Sim: Var, Smooth: 80, Spill: 50", "Sim: 400...", "All 0"], correct: 1 } },
                { q: "Greenline Issue", ans: "Setup: Proper lighting/camera. Live: Adjust similarity/spill slightly, or pick right color.", refresher: { options: ["Restart OBS", "Adjust similarity/spill", "Change BG", "Color correction"], correct: 1 } }
            ]}, { title: "Greenscreen Protection", questions: [
                { q: "Purpose of Greenscreen Protection", ans: "Maintains visibility of green items matching background (prevents transparency).", refresher: { options: ["Hide green items", "Maintain visibility of green items", "Protect screen", "Improve lighting"], correct: 1 } },
                { q: "Adding Greenscreen Protection", ans: "Copy camera group, add Chroma Key filter to group, crop source to host's body.", refresher: { options: ["Add Color Key filter", "Duplicate group, add Chroma, crop", "Physical blocker", "Change shirt"], correct: 1 } }
            ]}, { title: "OBS Internet & CPU Troubleshooting", questions: [
                { q: "Encoder Rate Control Check", ans: "If CBR fails, switch to VBR (Min 2500, Max 4500).", refresher: { options: ["Switch VBR to CBR", "Switch CBR to VBR...", "Disable Encoder", "Increase Bitrate"], correct: 1 } },
                { q: "CPU Usage Preset", ans: "Reduce CPU usage Preset by one level.", refresher: { options: ["Increase Quality", "Reduce CPU Preset", "Software Encoding", "Turn off Preview"], correct: 1 } },
                { q: "Switching to another ISP", ans: "If all fails, request ISP change (insufficient bandwidth).", refresher: { options: ["Use VPN", "Restart Router", "Request ISP change", "Use Wi-Fi"], correct: 2 } }
            ]}]},
            { category: "Camera Setup & Troubleshooting", sections: [{ title: "Camera Setup", questions: [
                { q: "Power Settings Option", ans: "Save Start Time: Off. Save by Monitor: Both Linked. Auto Off Temp: High.", refresher: { options: ["Save Start: On...", "Save Start: Off...", "Auto Off Temp...", "Power Saving..."], correct: 1 } },
                { q: "HDMI Settings", ans: "Res: 2160p/1080p. Output: 60p. Info Disp: Off.", refresher: { options: ["720p...", "2160p/1080p...", "4k, 24p...", "Interlaced"], correct: 1 } }
            ]}, { title: "Camera Cleaning", questions: [
                { q: "Brush", ans: "Brush outer part, avoid lens.", refresher: { options: ["Use soap", "Brush body, avoid lens", "Paper towel", "Finger smudge"], correct: 1 } },
                { q: "Air Pump", ans: "Pump air to remove dust after brushing.", refresher: { options: ["Blow with mouth", "Pump air", "Vacuum", "None"], correct: 1 } },
                { q: "Wet and Dry Wipes", ans: "Use wet on display/lens, then dry with dry wipes.", refresher: { options: ["Dry only", "Wet then dry", "Shirt", "Water"], correct: 1 } }
            ]}, { title: "Camera Troubleshooting", questions: [
                { q: "Functions: ISO, Shutter, Exposure, Focus", ans: "ISO: Brightness/Grain. Shutter: Sync/No Lag. Exposure: Lighting balance. Focus: Clarity.", refresher: { options: ["Saturation...", "ISO, Shutter, Exposure, Focus", "Zoom...", "White Balance..."], correct: 1 } },
                { q: "Standard Setup of Camera", ans: "Shutter: 1/160. Aperture: 3.5 (lowest). Focal: +1.0 to +1.7.", refresher: { options: ["Shutter: 1/50...", "Shutter: 1/160...", "Auto", "Shutter: 1/1000..."], correct: 1 } },
                { q: "Camera Overheating", ans: "Check Power Settings (Auto-off Temp High). Check Fan. Use external fan.", refresher: { options: ["Fridge", "Check Power/Fan", "Turn off fan", "Lower res"], correct: 1 } },
                { q: "Camera Blackscreen / No Output", ans: "Check Shoot Mode. Re-plug Capture Card. Restart Camera.", refresher: { options: ["New camera", "Check Shoot Mode/Capture Card", "Change lens", "Update Windows"], correct: 1 } },
                { q: "Robotic, Slow Motion, Lagging", ans: "Cause: Super Low Shutter Speed.", refresher: { options: ["High ISO", "Super Low Shutter Speed", "Aperture", "HDMI Cable"], correct: 1 } }
            ]}]}
        ];

        window.evalStructure = JSON.parse(JSON.stringify(BASE_QUESTIONS));
        window.evalStructure.push({
            category: "Soft Skills",
            sections: [{
                title: "Core Competencies",
                questions: [
                    { q: "Calm Under Pressure", ans: "Remains composed and thinks clearly, irrespective of technical malfunctions." },
                    { q: "Emotional Control", ans: "Does not let frustration, panic, or excitement affect decision-making." },
                    { q: "Focused Attention", ans: "Listens, observes, and reacts based only on facts and the live situation." },
                    { q: "Clear Communication", ans: "Maintains a steady voice and provides short, direct instructions." },
                    { q: "Situational Awareness", ans: "Maintains constant awareness to minimize and preempt mistakes." },
                    { q: "Confidence Through Preparation", ans: "Knows tools/plans, allowing fast reactions without overthinking." },
                    { q: "Professional Presence", ans: "Maintains composed demeanor, polite behavior, and respectful tone." },
                    { q: "Controlled Pace", ans: "Avoids rushing; takes actions with intention, step-by-step." },
                    { q: "Problem-Solving Mindset", ans: "Focus is on solutions/recovery rather than assigning blame." },
                    { q: "Technical Speed", ans: "Efficiency graded by trainer." }
                ]
            }]
        });

        window.refresherStructure = JSON.parse(JSON.stringify(BASE_QUESTIONS));

        window.toRoman = function(num) { const lookup = {M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1}; let roman = '', i; for ( i in lookup ) { while ( num >= lookup[i] ) { roman += i; num -= lookup[i]; } } return roman; }
        window.toLetter = function(num) { return String.fromCharCode(97 + num); }

        window.startEvaluation = function(id, evalId = null, forceType = null) {
            currentEvalEmployeeId = id;
            currentEditingEvalId = evalId;
            window.currentEvalType = forceType; 

            const emp = window.employees.find(e => e.id == id);
            if (!emp) return;
            
            let existingData = {};
            if (evalId) {
                const ev = emp.evaluations.find(x => x.id == evalId);
                if (ev && ev.details) { ev.details.forEach(d => { existingData[d.q] = d.score; }); }
                if (ev && ev.type) window.currentEvalType = ev.type;
            }

            const container = document.getElementById('eval-form-container');
            const titlePrefix = window.currentEvalType === 'Refresher' ? 'Refresher Assessment' : (window.currentEvalType === 'LOL Evaluation' ? 'LOL Evaluation' : 'Assessment');
            document.getElementById('eval-title').innerText = evalId ? `Edit ${titlePrefix}: ${emp.name}` : `${titlePrefix}: ${emp.name}`;
            container.innerHTML = '';
            
            window.updateLiveScore(0);
            const isRefresherMode = window.currentEvalType === 'Refresher';
            const liveScoreEl = document.getElementById('live-score-display');
            if(liveScoreEl) liveScoreEl.style.display = isRefresherMode ? 'none' : 'block';

            // SELECT THE CORRECT STRUCTURE FOR THE EXAM
            const structureToUse = isRefresherMode ? window.refresherStructure : window.evalStructure;

            structureToUse.forEach((cat, cIdx) => {
                const cDiv = document.createElement('div'); cDiv.className = "space-y-6"; 
                cDiv.innerHTML = `<h3 class="text-sm font-black text-blue-600 uppercase tracking-widest border-b pb-2">Part ${toRoman(cIdx+1)} - ${cat.category}</h3>`;
                
                cat.sections.forEach((sec, sIdx) => {
                    const sDiv = document.createElement('div'); sDiv.className = "space-y-4 ml-0 md:ml-2"; 
                    sDiv.innerHTML = `<h4 class="font-bold text-slate-800 text-sm">${sIdx + 1}. ${sec.title}</h4>`;
                    
                    sec.questions.forEach((q, qIdx) => {
                        const qId = `q_${cIdx}_${sIdx}_${qIdx}`;
                        const existingScore = existingData[q.q] || 0;
                        const useMultipleChoice = isRefresherMode && q.refresher && q.refresher.options;
                        let inputHtml = '';

                        if (useMultipleChoice) {
                            inputHtml = `<div class="grid grid-cols-1 gap-2 w-full">`;
                            q.refresher.options.forEach((opt, optIdx) => {
                                const isCorrectOption = optIdx === q.refresher.correct;
                                const scoreValue = isCorrectOption ? 1 : 0;
                                const activeClass = (existingScore === 1 && isCorrectOption) ? "border-blue-600 bg-blue-600 text-white shadow-md" : "border-slate-200 bg-white text-slate-700 hover:bg-blue-50";
                                const textClass = (existingScore === 1 && isCorrectOption) ? "text-white" : "text-blue-600";
                                inputHtml += `<button type="button" onclick="selectRefresherOption('${qId}', ${scoreValue}, this)" class="text-left px-4 py-3 rounded-xl border text-xs font-bold transition-all active:scale-95 focus:ring-2 focus:ring-blue-500 ${activeClass}" data-val="${scoreValue}"><span class="${textClass} mr-2">${toLetter(optIdx).toUpperCase()}.</span> ${opt}</button>`;
                            });
                            inputHtml += `</div><input type="hidden" id="${qId}" class="eval-input" value="${existingScore}">`;
                        } else {
                            const buttonsHtml = [1,2,3,4,5].map(v => {
                                const isSelected = existingScore === v;
                                const baseClass = "score-btn w-8 h-8 rounded-lg border text-xs font-black transition-all active:scale-90";
                                const stateClass = isSelected ? "border-blue-600 bg-blue-600 text-white shadow-md" : "border-slate-200 bg-white hover:bg-blue-50";
                                return `<button type="button" onclick="selectScore('${qId}', ${v})" id="${qId}_btn_${v}" class="${baseClass} ${stateClass}">${v}</button>`;
                            }).join('');
                            inputHtml = `<div class="w-full md:w-48 flex flex-col justify-center items-center bg-slate-50 rounded-xl p-3 border border-slate-100"><p class="text-[10px] font-black text-slate-400 uppercase mb-2">Grade (1-5)</p><div class="flex gap-2">${buttonsHtml}</div><input type="hidden" id="${qId}" class="eval-input" value="${existingScore}"></div>`;
                        }

                        const qDiv = document.createElement('div'); 
                        qDiv.className = "p-4 md:p-5 rounded-2xl bg-white border border-slate-100 shadow-sm space-y-4 ml-0 md:ml-2";
                        if (useMultipleChoice) {
                            qDiv.innerHTML = `<div class="flex items-start gap-2 mb-2"><span class="font-bold text-slate-400 text-sm pt-0.5">${toLetter(qIdx)}.</span><p class="text-sm font-semibold text-slate-700">${q.q}</p></div>${inputHtml}`;
                        } else {
                            qDiv.innerHTML = `<div class="flex items-start gap-2"><span class="font-bold text-slate-400 text-sm pt-0.5">${toLetter(qIdx)}.</span><p class="text-sm font-semibold text-slate-700">${q.q}</p></div><div class="flex flex-col md:flex-row gap-4"><div class="flex-1 bg-blue-50/50 p-3 rounded-xl border border-blue-100/50"><p class="text-[10px] text-blue-800 font-medium leading-relaxed break-words">${q.ans}</p></div>${inputHtml}</div>`;
                        }
                        sDiv.appendChild(qDiv);
                    });
                    cDiv.appendChild(sDiv);
                });
                container.appendChild(cDiv);
            });
            
            if (evalId) calculateLiveScore();
            const action = document.createElement('div'); action.className = "pt-10 flex justify-center pb-10"; action.innerHTML = `<button onclick="submitEvaluation()" class="w-full max-w-md bg-slate-900 text-white py-4 rounded-2xl font-black uppercase hover:bg-black transition-all shadow-xl flex items-center justify-center gap-2 active:scale-95"><i data-lucide="save"></i> ${evalId ? 'Update Record' : 'Submit Assessment'}</button>`;
            container.appendChild(action);
            switchView('eval');
        }

        window.selectRefresherOption = function(qId, score, btnEl) {
            document.getElementById(qId).value = score;
            const parent = btnEl.parentElement;
            const buttons = parent.querySelectorAll('button');
            buttons.forEach(b => {
                b.className = "text-left px-4 py-3 rounded-xl border border-slate-200 text-xs font-bold transition-all hover:bg-blue-50 active:scale-95 focus:ring-2 focus:ring-blue-500 bg-white text-slate-700";
                const span = b.querySelector('span');
                if(span) span.className = "text-blue-600 mr-2";
            });
            btnEl.className = "text-left px-4 py-3 rounded-xl border border-blue-600 bg-blue-600 text-white text-xs font-bold transition-all shadow-md active:scale-95";
            btnEl.querySelector('span').className = "text-white mr-2";
            calculateLiveScore();
        }

        window.selectScore = function(qId, val) {
            const input = document.getElementById(qId); input.value = val;
            for(let i=1; i<=5; i++) { 
                const b = document.getElementById(`${qId}_btn_${i}`); 
                b.className = "score-btn w-8 h-8 rounded-lg border border-slate-200 bg-white text-xs font-black transition-all hover:bg-blue-50 active:scale-90"; 
            }
            document.getElementById(`${qId}_btn_${val}`).className = "score-btn w-8 h-8 rounded-lg border border-blue-600 bg-blue-600 text-white text-xs font-black transition-all shadow-md";
            calculateLiveScore();
        }

        window.calculateLiveScore = function() {
            let totalS = 0, totalP = 0;
            const inputs = document.querySelectorAll('.eval-input');
            inputs.forEach(inp => {
                const val = parseInt(inp.value) || 0;
                if (val > 0) { totalS += val; totalP += 5; }
            });
            const score = totalP > 0 ? ((totalS / totalP) * 100).toFixed(1) : "0.0";
            window.updateLiveScore(score);
        }

        window.updateLiveScore = function(val) {
            const el = document.getElementById('live-score-display');
            if (el) {
                el.innerText = `${val}%`;
                if (parseFloat(val) >= 85) el.className = "px-4 py-2 bg-emerald-600 text-white rounded-xl font-black font-mono text-lg shadow-lg transition-colors";
                else if (parseFloat(val) >= 70) el.className = "px-4 py-2 bg-amber-500 text-white rounded-xl font-black font-mono text-lg shadow-lg transition-colors";
                else el.className = "px-4 py-2 bg-slate-900 text-white rounded-xl font-black font-mono text-lg shadow-lg transition-colors";
            }
        }

        window.submitEvaluation = function() {
            const emp = window.employees.find(e => e.id == currentEvalEmployeeId); if (!emp) return;
            let responses = [], totalS = 0, totalP = 0, inc = false;
            
            const isRefresher = window.currentEvalType === 'Refresher';
            const structureToUse = isRefresher ? window.refresherStructure : window.evalStructure;

            structureToUse.forEach((cat, cIdx) => {
                cat.sections.forEach((sec, sIdx) => {
                    sec.questions.forEach((q, qIdx) => {
                        const val = parseInt(document.getElementById(`q_${cIdx}_${sIdx}_${qIdx}`).value);
                        if(isNaN(val) || val === 0 && !isRefresher) inc = true; 
                        const isRefresherMC = isRefresher && q.refresher && q.refresher.options;
                        const maxPoints = isRefresherMC ? 1 : 5;
                        responses.push({ q: q.q, cat: cat.category, section: sec.title, score: val }); 
                        totalS += val; totalP += maxPoints;
                    });
                });
            });
            
            if(inc) { showNotification("Form incomplete."); return; }
            
            const scorePct = totalP > 0 ? ((totalS / totalP) * 100).toFixed(1) : "0.0";
            let updatedEvals = [...emp.evaluations];
            const evalData = { score: scorePct, totalScore: totalS, maxScore: totalP, details: responses };
            
            if (currentEditingEvalId) {
                updatedEvals = updatedEvals.map(ev => { if (ev.id == currentEditingEvalId) return { ...ev, ...evalData }; return ev; });
                window.saveEmployee({ ...emp, evaluations: updatedEvals }).then(() => { window.logActivity('eval', `Assessment Updated`, emp.name); viewReport(emp.id); });
            } else {
                const refresherCount = isRefresher ? (updatedEvals.filter(e => e.type === 'Refresher').length + 1) : 0;
                const standardPhaseMonth = updatedEvals.slice(emp.phaseStartIdx || 0).length + 1;
                const newEval = { id: Date.now(), phaseMonth: isRefresher ? refresherCount : standardPhaseMonth, type: window.currentEvalType || emp.status, date: new Date().toLocaleDateString(), ...evalData };
                updatedEvals.push(newEval);
                window.saveEmployee({ ...emp, evaluations: updatedEvals }).then(() => { window.logActivity('eval', `Assessment Logged`, emp.name); viewReport(emp.id); });
            }
        }

        window.deleteEvaluation = function(empId, evalId) {
            const emp = window.employees.find(e => e.id == empId);
            if (!emp) return;
            showConfirmModal("Delete Assessment", "This cannot be undone. Remove this score record?", () => {
                const updatedEvals = emp.evaluations.filter(e => e.id != evalId);
                window.saveEmployee({ ...emp, evaluations: updatedEvals }).then(() => { window.logActivity('delete', 'Assessment Removed', emp.name); viewReport(empId); });
            });
        }

        window.handleDecision = function(id, action) {
            const emp = window.employees.find(e => e.id == id); if (!emp) return;
            if(action === 'promote') {
                const oldS = emp.status, newS = oldS === 'Trainee' ? 'Probationary' : 'Regular';
                const effectiveDate = calculateNextDueDate(emp);
                const newAchievements = [...(emp.achievements || []), { id: Date.now(), title: `Promoted to ${newS}`, date: effectiveDate, type: newS, fromStatus: oldS, evaluations: [...emp.evaluations.slice(emp.phaseStartIdx || 0)] }];
                const updatedEmp = { ...emp, status: newS, achievements: newAchievements, phaseStartIdx: emp.evaluations.length, phaseLimit: 3 };
                window.saveEmployee(updatedEmp).then(() => { window.logActivity('promote', `Contract Advanced to ${newS}`, emp.name); const idx = window.employees.findIndex(e => e.id === id); if(idx !== -1) window.employees[idx] = updatedEmp; viewReport(id); showCongrats({ ...updatedEmp }); });
            } else {
                const updatedEmp = { ...emp, phaseLimit: (emp.phaseLimit || 3) + 1 };
                window.saveEmployee(updatedEmp).then(() => { window.logActivity('extend', `Review Cycle Extended`, emp.name); const idx = window.employees.findIndex(e => e.id === id); if(idx !== -1) window.employees[idx] = updatedEmp; viewReport(id); showNotification("Review Cycle Extended."); });
            }
        }

        window.viewReport = function(id) {
            const emp = window.employees.find(e => e.id == id);
            const parseDateLocal = (dateStr) => { const parts = dateStr.split('-'); return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])); };
            const formatDate = (dateObj) => { return dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }); };
            const addMonthsToHireDate = (months) => { const d = parseDateLocal(emp.hireDate); d.setMonth(d.getMonth() + months); return formatDate(d); };
            
            const dateHired = formatDate(parseDateLocal(emp.hireDate));
            const probAch = emp.achievements.find(a => a.type === 'Probationary');
            const regAch = emp.achievements.find(a => a.type === 'Regular');
            let dateProb = probAch ? addMonthsToHireDate(probAch.evaluations.length) : 'Pending';
            let dateReg = regAch ? addMonthsToHireDate((probAch ? probAch.evaluations.length : 0) + regAch.evaluations.length) : 'Pending';

            const phaseEvals = emp.evaluations.slice(emp.phaseStartIdx || 0);
            const isCycleComplete = phaseEvals.length >= (emp.phaseLimit || 3);
            const avg = phaseEvals.length ? (phaseEvals.reduce((a,c) => a+parseFloat(c.score),0)/phaseEvals.length).toFixed(1) : 0;
            
            const isAdmin = window.currentUserRole === 'lead' || window.currentUserRole === 'trainer';

            let actionButtonsHTML = '';
            
            // LOL Evaluation Button: Only visible to admins
            const lolButton = isAdmin ? `<button onclick="startEvaluation(${emp.id}, null, 'LOL Evaluation')" class="col-span-1 w-full py-3 border-2 border-slate-900 bg-transparent text-slate-900 rounded-xl text-xs font-black uppercase tracking-wider shadow-sm hover:bg-slate-50 flex items-center justify-center gap-2"><i data-lucide="star" class="w-4 h-4"></i> Conduct LOL Evaluation</button>` : '';

            // Refresher: Accessible to everyone (Operators can "access" implies take/start)
            const refresherBtn = `
                <button onclick="startEvaluation(${emp.id}, null, 'Refresher')" class="w-full py-3 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-wider shadow-lg active:scale-95 flex items-center justify-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Add Monthly Refresher
                </button>
            `;

            // Admin Actions block
            const adminActions = isAdmin ? (
                isCycleComplete ? `
                    <div class="bg-blue-50 border border-blue-100 p-4 rounded-2xl mb-6">
                        <p class="text-[10px] font-black text-blue-600 uppercase mb-3 text-center">Cycle Finished (Avg: ${avg}%)</p>
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="handleDecision(${emp.id}, 'promote')" class="py-3 bg-emerald-600 text-white rounded-xl text-xs font-black uppercase hover:bg-emerald-700 flex items-center justify-center gap-2 shadow-lg active:scale-95"><i data-lucide="check-circle" class="w-4 h-4"></i> Promote to ${emp.status === 'Trainee' ? 'Probationary' : 'Regular'}</button>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="handleDecision(${emp.id}, 'extend')" class="py-3 bg-amber-500 text-white rounded-xl text-xs font-black uppercase hover:bg-amber-600 flex items-center justify-center gap-2 shadow-md active:scale-95"><i data-lucide="plus" class="w-4 h-4"></i> Extend</button>
                                <button onclick="confirmTermination(${emp.id})" class="py-3 bg-rose-600 text-white rounded-xl text-xs font-black uppercase hover:bg-rose-700 flex items-center justify-center gap-2 shadow-md active:scale-95"><i data-lucide="user-x" class="w-4 h-4"></i> Terminate</button>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
                        <button onclick="startEvaluation(${emp.id})" class="col-span-1 py-3 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-wider shadow-lg active:scale-95 flex items-center justify-center gap-2"><i data-lucide="clipboard-check" class="w-4 h-4"></i> Assess M${phaseEvals.length+1}</button>
                        <button onclick="confirmTermination(${emp.id})" class="col-span-1 py-3 border border-rose-100 bg-rose-50 text-rose-500 rounded-xl text-xs font-black uppercase active:scale-95 hover:bg-rose-100 transition-colors">Terminate</button>
                        <div class="col-span-1 sm:col-span-2">${lolButton}</div>
                    </div>
                `
            ) : ''; // Operators get empty string for admin actions

            if (emp.status === 'Regular') {
                const nextRefresher = calculateNextDueDate(emp);
                actionButtonsHTML = `
                    <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-[10px] font-black text-emerald-600 uppercase">Regular Status Active</p>
                            <p class="text-[9px] font-bold text-slate-400 uppercase">Next Refresher: <span class="text-slate-700">${nextRefresher}</span></p>
                        </div>
                        <div class="space-y-2">
                            ${refresherBtn}
                            ${lolButton}
                        </div>
                    </div>
                `;
            } else if (emp.status !== 'Terminated') {
                actionButtonsHTML = adminActions;
            }

            const terminateNotice = (isAdmin && emp.status === 'Terminated') ? `<div class="mt-4"><button onclick="generateTerminationLetter(${emp.id})" class="w-full py-2 bg-rose-600 text-white rounded-xl text-[10px] font-black uppercase shadow-lg">Notice of Termination (PDF)</button></div>` : '';

            const container = document.getElementById('report-content');
            container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <div class="glass-card p-8 rounded-3xl text-center shadow-md border-b-4 border-b-blue-600">
                        <div class="w-24 h-24 bg-blue-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 font-black text-3xl shadow-lg uppercase">${emp.name.charAt(0)}</div>
                        <h3 class="text-2xl font-black text-slate-900">${emp.name}</h3>
                        <span class="px-4 py-1.5 bg-slate-100 rounded-full text-[10px] font-black uppercase tracking-widest text-slate-500 block w-fit mx-auto mt-2 mb-6">${emp.status}</span>
                        <div class="text-left space-y-3 bg-slate-50 p-4 rounded-2xl border border-slate-100 mb-6">
                            <div class="flex justify-between items-center"><span class="text-[10px] font-bold text-slate-400 uppercase">Hired</span><span class="text-xs font-black text-slate-800">${dateHired}</span></div>
                            <div class="flex justify-between items-center"><span class="text-[10px] font-bold text-slate-400 uppercase">Probation</span><span class="text-xs font-black ${dateProb !== 'Pending' ? 'text-purple-600' : 'text-slate-400'}">${dateProb}</span></div>
                            <div class="flex justify-between items-center"><span class="text-[10px] font-bold text-slate-400 uppercase">Regular</span><span class="text-xs font-black ${dateReg !== 'Pending' ? 'text-emerald-600' : 'text-slate-400'}">${dateReg}</span></div>
                        </div>
                        ${actionButtonsHTML}
                        ${terminateNotice}
                    </div>
                    <div class="glass-card p-6 rounded-3xl shadow-sm">
                        <h4 class="font-black text-slate-900 mb-6 flex items-center gap-2 text-xs uppercase tracking-widest"><i data-lucide="award" class="w-4 h-4 text-amber-500"></i> Career Milestones</h4>
                        <div class="space-y-4">${emp.achievements.map(a => `<div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl space-y-3"><div class="flex justify-between items-start"><p class="text-xs font-black text-slate-800">${a.title}</p><p class="text-[9px] font-bold text-amber-700 bg-amber-100 px-2 py-1 rounded-md">${a.date}</p></div><div class="flex gap-2"><button onclick="viewCardFromAchievement(${emp.id}, ${a.id})" class="flex-1 py-1.5 bg-white border border-amber-200 text-amber-600 rounded-lg text-[10px] font-bold uppercase hover:bg-amber-50">Certificate</button>${isAdmin ? `<button onclick="generateEndorsementLetter(${emp.id}, ${a.id})" class="flex-1 py-1.5 bg-amber-500 text-white rounded-lg text-[10px] font-bold uppercase hover:bg-amber-600">Endorsement</button>` : ''}</div></div>`).join('') || '<p class="text-xs text-slate-400 italic">No cloud milestones logged.</p>'}</div>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-card p-8 rounded-3xl shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="font-black text-slate-900 flex items-center gap-2 text-xs uppercase tracking-widest"><i data-lucide="activity" class="w-4 h-4 text-blue-500"></i> Performance Logs</h4>
                            <span class="text-[10px] font-bold text-slate-400">Total: ${emp.evaluations.length}</span>
                        </div>
                        <div class="space-y-3">
                        ${emp.evaluations.slice().reverse().map(ev => {
                            const isRefresher = ev.type === 'Refresher';
                            const isLOL = ev.type === 'LOL Evaluation';
                            let scoreDisplay = isRefresher ? (ev.totalScore !== undefined ? `${ev.totalScore}/${ev.maxScore}` : `${ev.score}`) : `${ev.score}%`;
                            let labelColor = isRefresher ? 'text-blue-600' : (isLOL ? 'text-amber-500' : 'text-blue-600');
                            let labelText = isRefresher ? 'REF' : (isLOL ? 'LOL' : `PH${ev.phaseMonth}`);

                            const recordActions = isAdmin ? `
                                <div class="flex gap-1 border-l pl-4 border-slate-200">
                                    <button onclick="startEvaluation(${emp.id}, ${ev.id})" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all" title="Edit Score"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button onclick="deleteEvaluation(${emp.id}, ${ev.id})" class="p-2 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all" title="Delete Record"><i data-lucide="trash" class="w-4 h-4"></i></button>
                                </div>
                            ` : '';

                            return `
                            <div class="flex flex-col md:flex-row items-center justify-between p-5 bg-slate-50/50 rounded-2xl border border-slate-100 hover:bg-white transition-all group gap-4">
                                <div onclick="showEvalDetail(${emp.id}, ${ev.id})" class="flex items-center gap-4 flex-grow cursor-pointer w-full md:w-auto">
                                    <div class="bg-white p-3 rounded-xl shadow-sm text-[10px] font-black uppercase ${labelColor}">${labelText}</div>
                                    <div>
                                        <p class="text-xs font-black text-slate-700 uppercase">${ev.type}</p>
                                        <p class="text-[10px] text-slate-400 font-bold">${ev.date}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-6 w-full md:w-auto justify-between md:justify-end">
                                    <div class="text-right">
                                        <p class="text-xl font-black ${ev.score >= 80 ? 'text-emerald-600' : 'text-rose-600'}">${scoreDisplay}</p>
                                        <span class="text-[8px] font-black uppercase text-blue-500 cursor-pointer" onclick="showEvalDetail(${emp.id}, ${ev.id})">View</span>
                                    </div>
                                    ${recordActions}
                                </div>
                            </div>
                        `}).join('') || '<p class="text-xs italic text-slate-400 text-center py-10">No cloud records found.</p>'}
                        </div>
                    </div>
                </div>
            </div>`;
            switchView('report');
            lucide.createIcons();
        }

        window.showEvalDetail = function(empId, evalId) {
            const emp = window.employees.find(e => e.id == empId), ev = emp.evaluations.find(e => e.id == evalId); if (!ev) return;
            const isRefresher = ev.type === 'Refresher';
            const breakdown = {};
            ev.details.forEach(d => {
                const cat = d.cat; const sec = d.section; const score = parseFloat(d.score);
                if (!breakdown[cat]) breakdown[cat] = { total: 0, max: 0, sections: {} };
                if (!breakdown[cat].sections[sec]) breakdown[cat].sections[sec] = { total: 0, max: 0 };
                breakdown[cat].total += score;
                let qMax = (isRefresher && !d.cat.includes('Skills')) ? 1 : 5;
                breakdown[cat].max += qMax; 
                breakdown[cat].sections[sec].total += score;
                breakdown[cat].sections[sec].max += qMax;
            });

            // Use the stored structure to maintain order in report
            const structureToUse = isRefresher ? window.refresherStructure : window.evalStructure;

            let tableRows = '';
            let breakdownHTML = `<div class="mt-8 mb-8 no-break"><h2 class="text-sm font-black uppercase tracking-widest text-slate-900 border-l-4 border-slate-900 pl-4 py-1 mb-4">II. Detailed Score Breakdown</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
            let catIndex = 1;
            for (const structCat of structureToUse) {
                const catName = structCat.category;
                const data = breakdown[catName];
                if (data) {
                     const catPct = data.max > 0 ? ((data.total / data.max) * 100).toFixed(1) : 0;
                     const catScoreDisplay = isRefresher ? `${data.total} / ${data.max}` : `${catPct}%`;
                     let secHTML = '';
                     let secIndex = 1;
                     for (const structSec of structCat.sections) {
                         const secName = structSec.title;
                         const sData = data.sections[secName];
                         if (sData) {
                             const sPct = sData.max > 0 ? ((sData.total / sData.max) * 100).toFixed(1) : 0;
                             const sScoreDisplay = isRefresher ? `${sData.total}/${sData.max}` : `${sPct}%`;
                             const sSubDisplay = isRefresher ? '' : `(${sData.total}/${sData.max})`; 
                             secHTML += `<div class="flex justify-between items-center text-[10px] py-1 border-b border-slate-100 last:border-0"><span class="text-slate-600 font-bold">${secIndex}. ${secName}</span><span class="font-black text-slate-900">${sScoreDisplay} <span class="text-slate-400 font-normal">${sSubDisplay}</span></span></div>`;
                         }
                         secIndex++;
                     }
                     breakdownHTML += `<div class="bg-slate-50 p-4 rounded-xl border border-slate-200 no-break"><div class="flex justify-between items-center mb-3 border-b-2 border-slate-200 pb-2"><span class="font-black text-xs uppercase text-blue-900">Part ${toRoman(catIndex)}: ${catName}</span><span class="font-black text-lg text-blue-600">${catScoreDisplay}</span></div><div class="space-y-1">${secHTML}</div></div>`;
                }
                catIndex++;
            }
            breakdownHTML += `</div></div>`;
            ev.details.forEach(d => {
                 let maxP = (isRefresher && !d.cat.includes('Skills')) ? 1 : 5;
                 const scoreDisp = maxP === 1 ? `${d.score} / 1` : `${d.score} / 5.0`;
                 tableRows += `<tr><td class="p-4 border font-bold text-slate-700 text-[10px]">${d.q}</td><td class="p-4 border text-right font-black text-blue-600 text-[10px]">${scoreDisp}</td></tr>`;
            });

            let finalScoreDisplay = isRefresher ? (ev.totalScore !== undefined ? `${ev.totalScore} / ${ev.maxScore}` : `${ev.score}`) : `${ev.score}%`;
            const scoreLabel = isRefresher ? "Total Score" : "Weighted Final Grade";

            document.getElementById('eval-detail-content').innerHTML = `
                <div class="space-y-12">
                    <div class="no-break flex flex-col md:flex-row justify-between items-start border-b-8 border-slate-900 pb-8 uppercase font-black tracking-tighter gap-4">
                        <div><h1 class="text-2xl">M-Commerce Corporation</h1><p class="text-sm font-bold text-blue-600 uppercase tracking-widest">Performance Evaluation Dossier</p></div>
                        <div class="text-right"><p class="text-[10px] text-slate-400 uppercase">${scoreLabel}</p><p class="text-7xl text-slate-900 leading-none">${finalScoreDisplay}</p></div>
                    </div>
                    <div class="no-break grid grid-cols-2 md:grid-cols-4 gap-6 bg-slate-50 p-6 rounded-3xl border text-[10px] uppercase font-black">
                        <div><p class="text-slate-400 mb-1">Subject Personnel</p><p>${emp.name}</p></div>
                        <div><p class="text-slate-400 mb-1">Date of Assessment</p><p>${ev.date}</p></div>
                        <div><p class="text-slate-400 mb-1">Functional Group</p><p>Operations</p></div>
                        <div><p class="text-slate-400 mb-1">Phase Hierarchy</p><p>${ev.type} | Mo. ${ev.phaseMonth}</p></div>
                    </div>
                    <div class="no-break space-y-6 text-xs text-slate-600 leading-relaxed text-justify">
                        <h2 class="text-sm font-black uppercase tracking-widest text-slate-900 border-l-4 border-slate-900 pl-4 py-1">I. Technical Audit Summary</h2>
                        <p>This performance dossier provides a comprehensive technical audit for <strong>${emp.name}</strong> during the <strong>${ev.type}</strong> phase. 
                        The evaluation assessed specific grouped competencies including <strong>OBS Setup & Troubleshooting</strong>, <strong>Camera Technical Configurations</strong>, and core <strong>Operational Skills</strong>. 
                        A final result of <strong>${finalScoreDisplay}</strong> was achieved based on these categorized performance indicators.</p>
                    </div>
                    ${breakdownHTML}
                    <div class="overflow-x-auto no-break">
                    <h2 class="text-sm font-black uppercase tracking-widest text-slate-900 border-l-4 border-slate-900 pl-4 py-1 mb-4">III. Complete Itemized Response Log</h2>
                    <table class="w-full text-[10px] border-collapse border border-slate-200"><thead><tr class="bg-slate-900 text-white"><th class="p-4 border text-left uppercase w-3/4">Assessment Indicator</th><th class="p-4 border text-right uppercase w-1/4">Score</th></tr></thead><tbody>${tableRows}</tbody></table>
                    </div>
                    <div class="no-break pt-24 grid grid-cols-1 md:grid-cols-2 gap-y-24 gap-x-12 px-6 font-black text-[8px] text-center uppercase tracking-[0.2em] text-black"><div class="border-t-2 border-black pt-4">Live Operator Trainee</div><div class="border-t-2 border-black pt-4">Live Operator Trainer</div><div class="border-t-2 border-black pt-4">Live Operator Lead</div><div class="border-t-2 border-black pt-4">Technical Support Supervisor</div></div>
                </div>`;
            document.getElementById('back-to-report-btn').onclick = () => viewReport(empId);
            document.getElementById('download-eval-pdf').onclick = () => downloadPDF('eval-detail-content', `${emp.name}_Evaluation_Report.pdf`);
            switchView('eval-detail');
        }

        window.downloadCertificatePDF = async function(filename) {
            const el = document.getElementById('cert-pdf-wrapper');
            const opt = { margin: 0, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, letterRendering: true, scrollY: 0 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['css', 'legacy'] } };
            showNotification("Generating Landscape Certificate...");
            try { await html2pdf().set(opt).from(el).save(); } catch (e) { console.error(e); showNotification("Export failed."); }
        }
        
        window.viewCardFromAchievement = function(empId, achId) {
            const emp = window.employees.find(e => e.id == empId);
            const a = emp.achievements.find(ach => ach.id == achId);
            if (!a) return;
            document.getElementById('cert-name').innerText = emp.name;
            document.getElementById('cert-status').innerText = a.type;
            document.getElementById('cert-date').innerText = formatDateStandard(a.date);
            document.getElementById('download-cert-pdf').onclick = () => window.downloadCertificatePDF(`${emp.name}_Certificate.pdf`);
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('congrats-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        window.downloadPDF = async function(elId, filename) {
            const el = document.getElementById(elId);
            const opt = { margin: [0.5, 0.5, 0.5, 0.5], filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, letterRendering: true, scrollY: 0 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['css', 'legacy'] } };
            showNotification("Processing formal export...");
            try { await html2pdf().set(opt).from(el).save(); } catch (e) { showNotification("Export failed."); }
        }

        window.backupData = function() {
            const data = { employees: window.employees, activityLog: window.activityLog, evalStructure: window.evalStructure, refresherStructure: window.refresherStructure, version: "Cloud-Pro-3.5", ts: Date.now() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `MCorp_Tracker_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click(); URL.revokeObjectURL(url);
            showNotification("Dossier Backup Created.");
        }

        window.restoreData = function(event) {
            const file = event.target.files[0]; 
            event.target.value = '';
            if(!file) return;
            showConfirmModal("Restore Data", "This will merge backup data into the cloud. Existing IDs will be updated. Continue?", () => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data.employees && Array.isArray(data.employees)) {
                            showNotification("Processing Restore...");
                            const existingMap = new Map();
                            window.employees.forEach(emp => existingMap.set(emp.id, emp.firebaseId));
                            let count = 0;
                            for (const backupEmp of data.employees) {
                                const { firebaseId: oldFbId, ...empData } = backupEmp;
                                if (existingMap.has(empData.id)) {
                                    empData.firebaseId = existingMap.get(empData.id);
                                    await window.saveEmployee(empData, true);
                                } else { await window.saveEmployee(empData, true); }
                                count++;
                            }
                            // Restore Structures
                            if(data.evalStructure) window.evalStructure = data.evalStructure;
                            if(data.refresherStructure) window.refresherStructure = data.refresherStructure;
                            if(data.evalStructure || data.refresherStructure) await window.saveEvalStructure(true);
                            
                            showNotification(`Sync Complete: ${count} Records.`);
                        } else { showNotification("Invalid Backup File."); }
                    } catch (err) { console.error("Restore Error:", err); showNotification("Corrupt Data File."); }
                };
                reader.readAsText(file);
            });
        }

        window.showNotification = function(text) {
            const div = document.createElement('div');
            div.className = "no-print fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl z-[100] font-black uppercase text-xs tracking-widest flex items-center gap-3 animate-bounce";
            div.innerHTML = `<i data-lucide="bell" class="w-4 h-4 text-blue-400"></i> ${text}`;
            document.body.appendChild(div);
            lucide.createIcons();
            setTimeout(() => div.remove(), 4000);
        }

        window.getStatusClass = function(s) {
            switch(s) {
                case 'Trainee': return 'bg-blue-50 text-blue-600 border border-blue-100';
                case 'Probationary': return 'bg-purple-50 text-purple-600 border border-purple-100';
                case 'Regular': return 'bg-emerald-50 text-emerald-600 border border-emerald-100';
                default: return 'bg-rose-50 text-rose-600 border border-rose-100';
            }
        }
        
        // --- EDITOR LOGIC ---
        // Helper to get the array we are currently editing
        window.getCurrentStructure = function() {
            const mode = document.getElementById('editor-mode-select').value;
            return mode === 'refresher' ? window.refresherStructure : window.evalStructure;
        }

        window.switchEditorMode = function() {
            // Re-render based on selection
            const catSelect = document.getElementById('editor-category-select');
            const structure = window.getCurrentStructure();
            catSelect.innerHTML = structure.map((c, i) => `<option value="${i}">${c.category}</option>`).join('');
            window.renderEditorSections();
        }

        window.openQuestionManager = function() {
             document.getElementById('modal-backdrop').classList.remove('hidden');
             document.getElementById('question-editor-modal').classList.remove('hidden');
             document.getElementById('question-editor-modal').classList.add('flex');
             // Initialize view
             window.switchEditorMode();
        }

        window.renderEditorSections = function() {
            const cIdx = document.getElementById('editor-category-select').value;
            const secSelect = document.getElementById('editor-section-select');
            const structure = window.getCurrentStructure();
            
            if (!structure[cIdx]) { secSelect.innerHTML = ""; return; }
            
            const cat = structure[cIdx];
            secSelect.innerHTML = cat.sections.map((s, i) => `<option value="${i}">${s.title}</option>`).join('');
            renderEditorQuestions();
        }

        window.renderEditorQuestions = function() {
             const cIdx = document.getElementById('editor-category-select').value;
             const sIdx = document.getElementById('editor-section-select').value;
             const container = document.getElementById('editor-questions-list');
             const structure = window.getCurrentStructure();
             
             if (!structure[cIdx] || !structure[cIdx].sections[sIdx]) { container.innerHTML = '<p class="text-center text-slate-400 italic mt-10">Select a category and section to edit questions.</p>'; return; }
             
             const section = structure[cIdx].sections[sIdx];
             const isRefresherMode = document.getElementById('editor-mode-select').value === 'refresher';

             container.innerHTML = section.questions.map((q, qIdx) => {
                 const hasRefresher = !!(q.refresher && q.refresher.options);
                 let refresherHtml = '';
                 // Show MC editor if we are in refresher mode OR if the question has legacy MC data
                 if(isRefresherMode) {
                     // Ensure refresher object exists if missing (auto-fix for new questions in refresher mode)
                     if(!q.refresher) {
                         q.refresher = { options: ["Option A", "Option B", "Option C", "Option D"], correct: 0 };
                     }
                     refresherHtml = `
                        <div class="mt-4 bg-slate-100 p-3 rounded-lg border border-slate-200"><p class="text-[10px] font-black uppercase text-blue-600 mb-2">Multiple Choice Options</p><div class="grid grid-cols-1 gap-2">${q.refresher.options.map((opt, oIdx) => `<div class="flex gap-2 items-center"><input type="radio" name="correct_${cIdx}_${sIdx}_${qIdx}" ${q.refresher.correct === oIdx ? 'checked' : ''} onchange="window.updateQuestionCorrect(${cIdx}, ${sIdx}, ${qIdx}, ${oIdx})"><input type="text" class="w-full text-xs p-2 border rounded" value="${opt}" oninput="window.updateQuestionOption(${cIdx}, ${sIdx}, ${qIdx}, ${oIdx}, this.value)"></div>`).join('')}</div></div>
                     `;
                 } else { refresherHtml = `<div class="mt-2 text-xs text-slate-400 italic">Standard scoring (1-5)</div>`; }

                 return `
                    <div class="bg-white border border-slate-200 p-4 rounded-xl shadow-sm group"><div class="flex justify-between items-start mb-2"><span class="font-black text-slate-300 text-xs">Q${qIdx+1}</span><button onclick="window.deleteQuestion(${cIdx}, ${sIdx}, ${qIdx})" class="text-rose-400 hover:text-rose-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><div class="space-y-2"><div><label class="text-[10px] uppercase font-bold text-slate-400">Question</label><input type="text" class="w-full font-bold text-slate-800 border-b border-slate-200 focus:border-blue-500 outline-none py-1" value="${q.q}" oninput="window.updateQuestionText(${cIdx}, ${sIdx}, ${qIdx}, 'q', this.value)"></div><div><label class="text-[10px] uppercase font-bold text-slate-400">Answer Guide</label><textarea class="w-full text-xs text-slate-600 border rounded-lg p-2 focus:ring-1 focus:ring-blue-500 outline-none" rows="2" oninput="window.updateQuestionText(${cIdx}, ${sIdx}, ${qIdx}, 'ans', this.value)">${q.ans}</textarea></div>${refresherHtml}</div></div>
                 `;
             }).join('');
             lucide.createIcons();
        }

        window.updateQuestionText = function(cIdx, sIdx, qIdx, field, val) { 
            const structure = window.getCurrentStructure();
            structure[cIdx].sections[sIdx].questions[qIdx][field] = val; 
        }
        window.updateQuestionOption = function(cIdx, sIdx, qIdx, oIdx, val) { 
            const structure = window.getCurrentStructure();
            structure[cIdx].sections[sIdx].questions[qIdx].refresher.options[oIdx] = val; 
        }
        window.updateQuestionCorrect = function(cIdx, sIdx, qIdx, correctIdx) { 
            const structure = window.getCurrentStructure();
            structure[cIdx].sections[sIdx].questions[qIdx].refresher.correct = correctIdx; 
        }
        
        window.addQuestion = function() {
             const cIdx = document.getElementById('editor-category-select').value;
             const sIdx = document.getElementById('editor-section-select').value;
             const structure = window.getCurrentStructure();
             const isRefresherMode = document.getElementById('editor-mode-select').value === 'refresher';

             if(!structure[cIdx] || !structure[cIdx].sections[sIdx]) return;
             
             const newQ = { q: "New Question", ans: "Answer Guide", refresher: isRefresherMode ? { options: ["Option A", "Option B", "Option C", "Option D"], correct: 0 } : null };
             structure[cIdx].sections[sIdx].questions.push(newQ);
             renderEditorQuestions();
        }

        window.deleteQuestion = function(cIdx, sIdx, qIdx) {
            showConfirmModal("Delete Question", "Are you sure you want to remove this item?", () => {
                const structure = window.getCurrentStructure();
                structure[cIdx].sections[sIdx].questions.splice(qIdx, 1);
                renderEditorQuestions();
            });
        }
        
        // --- Structure Management (Add/Edit/Delete Categories & Sections) ---
        window.addCategory = function() {
            showPromptModal("Add Category", "Enter new category name:", "", (val) => {
                const structure = window.getCurrentStructure();
                structure.push({ category: val, sections: [] });
                window.switchEditorMode(); // Refresh dropdown
                // Select new
                document.getElementById('editor-category-select').value = structure.length - 1;
                window.renderEditorSections();
            });
        }
        
        window.renameCategory = function() {
            const cIdx = document.getElementById('editor-category-select').value;
            const structure = window.getCurrentStructure();
            const currentName = structure[cIdx].category;
            showPromptModal("Rename Category", "Enter new name:", currentName, (val) => {
                structure[cIdx].category = val;
                document.getElementById('editor-category-select').options[cIdx].text = val;
            });
        }
        
        window.deleteCategory = function() {
             const cIdx = document.getElementById('editor-category-select').value;
             showConfirmModal("Delete Category", "Remove entire category and all contained sections?", () => {
                 const structure = window.getCurrentStructure();
                 structure.splice(cIdx, 1);
                 window.switchEditorMode();
             });
        }

        window.addSection = function() {
             const cIdx = document.getElementById('editor-category-select').value;
             showPromptModal("Add Section", "Enter new section name:", "", (val) => {
                 const structure = window.getCurrentStructure();
                 structure[cIdx].sections.push({ title: val, questions: [] });
                 window.renderEditorSections();
                 document.getElementById('editor-section-select').value = structure[cIdx].sections.length - 1;
                 renderEditorQuestions();
             });
        }
        
        window.renameSection = function() {
             const cIdx = document.getElementById('editor-category-select').value;
             const sIdx = document.getElementById('editor-section-select').value;
             const structure = window.getCurrentStructure();
             const currentName = structure[cIdx].sections[sIdx].title;
             showPromptModal("Rename Section", "Enter new name:", currentName, (val) => {
                 structure[cIdx].sections[sIdx].title = val;
                 document.getElementById('editor-section-select').options[sIdx].text = val;
             });
        }
        
        window.deleteSection = function() {
             const cIdx = document.getElementById('editor-category-select').value;
             const sIdx = document.getElementById('editor-section-select').value;
             showConfirmModal("Delete Section", "Remove section and all its questions?", () => {
                 const structure = window.getCurrentStructure();
                 structure[cIdx].sections.splice(sIdx, 1);
                 renderEditorSections();
             });
        }
        
        // --- End Structure Management ---

        // Firebase Configuration
        const userProvidedConfig = {
          	 apiKey: "AIzaSyAKUM3Mo91_Gm-Rj5x7EgrN43HWUpxYprU",
  authDomain: "traineetracker-91496.firebaseapp.com",
  projectId: "traineetracker-91496",
  storageBucket: "traineetracker-91496.firebasestorage.app",
  messagingSenderId: "930372715628",
  appId: "1:930372715628:web:e76cbce93faf492b494449",
  measurementId: "G-YXB1YTESWG"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedConfig;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // Shared Global State
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        
        // Attach form handler manually since module script scope is different
        document.getElementById('add-trainee-form').onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const firebaseId = formData.get('firebaseId');
            const id = formData.get('id') || Date.now();
            const name = formData.get('name');
            const hireDate = formData.get('hireDate');
            const status = formData.get('status') || 'Trainee';

            if (firebaseId) {
                const emp = window.employees.find(e => e.firebaseId == firebaseId);
                if (emp) {
                    window.saveEmployee({
                        firebaseId, id: parseInt(id), name, hireDate,
                        status: status, // Use selected status
                        evaluations: emp.evaluations,
                        achievements: emp.achievements, phaseStartIdx: emp.phaseStartIdx, phaseLimit: emp.phaseLimit
                    }).then(() => window.logActivity('edit', 'Updated personnel details', name));
                }
            } else {
                window.saveEmployee({
                    id: parseInt(id), name, hireDate, 
                    status: status, // Use selected status
                    evaluations: [], achievements: [], phaseStartIdx: 0, phaseLimit: 3
                }).then(() => window.logActivity('new_hire', 'New personnel registered', name));
            }
            closeModal();
        };

        // Auth Logic with Error Handling
        async function startSystem() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (e) {
                        console.warn("Custom token failed, falling back to anonymous.");
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                showNotification("Database Auth Failed.");
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Session Active:", user.uid);
                setupRealtimeSync();
            }
        });

        // Data Sync
        function setupRealtimeSync() {
            if (!auth.currentUser) return;
            const employeesRef = collection(db, 'artifacts', appId, 'public', 'data', 'employees');
            const activityRef = collection(db, 'artifacts', appId, 'public', 'data', 'activity');
            const settingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'settings');

            onSnapshot(employeesRef, (snapshot) => {
                window.employees = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
                renderDashboard();
            }, (error) => {
                if (error.code === 'permission-denied') showNotification("Permission Denied: Check Rules.");
            });

            onSnapshot(activityRef, (snapshot) => {
                window.activityLog = snapshot.docs.map(doc => doc.data())
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                renderDashboard();
            });

            onSnapshot(settingsRef, (snapshot) => {
                snapshot.forEach(doc => {
                    if(doc.id === 'structure') {
                        const d = doc.data();
                        // Sync both structures
                        if(d.data) window.evalStructure = d.data;
                        if(d.refresherData) window.refresherStructure = d.refresherData;
                    }
                });
            });
        }

        // Global Handlers
        window.logActivity = async function(type, message, empName) {
            if (!auth.currentUser) return;
            try {
                const activityRef = collection(db, 'artifacts', appId, 'public', 'data', 'activity');
                await addDoc(activityRef, { type, message, empName, date: new Date().toLocaleString(), timestamp: Date.now() });
            } catch (e) { console.error("Log failed", e); }
        };

        window.saveEmployee = async function(empData, silent = false) {
            if (!auth.currentUser) return;
            const employeesRef = collection(db, 'artifacts', appId, 'public', 'data', 'employees');
            try {
                if (empData.firebaseId) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'employees', empData.firebaseId);
                    const { firebaseId, ...cleanData } = empData;
                    await updateDoc(docRef, cleanData);
                } else {
                    await addDoc(employeesRef, empData);
                }
                if (!silent) showNotification("Record Saved.");
            } catch (e) { 
                if (!silent) showNotification("Save Failed."); 
            }
        };

        // Save Structure to DB
        window.saveEvalStructure = async function(silent = true) {
            if (!auth.currentUser) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'structure');
                // Save both standard and refresher structures
                await setDoc(docRef, { data: window.evalStructure, refresherData: window.refresherStructure });
                if(!silent) showNotification("Questions Updated.");
            } catch(e) {
                console.error("Save Structure Failed", e);
            }
        }

        window.deleteEmployee = async function(firebaseId) {
            if (!auth.currentUser) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'employees', firebaseId);
                await deleteDoc(docRef);
                showNotification("Record Deleted.");
            } catch (e) { console.error(e); }
        };

        window.factoryResetDB = async function() {
            if (!auth.currentUser) return;
            try {
                const employeesRef = collection(db, 'artifacts', appId, 'public', 'data', 'employees');
                const activityRef = collection(db, 'artifacts', appId, 'public', 'data', 'activity');
                const [empSnap, actSnap] = await Promise.all([getDocs(employeesRef), getDocs(activityRef)]);
                const deletions = [];
                empSnap.forEach(d => deletions.push(deleteDoc(d.ref)));
                actSnap.forEach(d => deletions.push(deleteDoc(d.ref)));
                await Promise.all(deletions);
                location.reload();
            } catch (e) { console.error(e); }
        };

        // Ensure default view is blocked if not logged in
        window.addEventListener('load', () => {
            // Force show login screen
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-content').classList.add('hidden');
        });

        startSystem();
    </script>
</body>
</html>