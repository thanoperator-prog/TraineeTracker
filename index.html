<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Commerce Corporation | Trainee Tracking System</title>
    
    <!-- PWA Metadata -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="M-Corp Tracker">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .printable-report { 
            background: white; 
            width: 100%;
            max-width: 8.5in; 
            margin: 0 auto;
            color: #1e293b;
            padding: 0.5in;
        }

        .no-break { page-break-inside: avoid; }
        .page-break { page-break-before: always; }

        .certificate-border {
            border: 15px solid transparent;
            border-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0H100V100H0V0ZM5 5V95H95V5H5Z' fill='%23B48C36'/%3E%3Cpath d='M10 10V90H90V10H10ZM12 12H88V88H12V12Z' fill='%23D4AF37'/%3E%3C/svg%3E") 30 stretch;
            background: #fff;
        }

        .cert-title { font-family: 'Playfair Display', serif; color: #1e293b; }
        .cert-gold-text { color: #B48C36; }
        .nav-link-active { color: #2563eb; border-bottom: 2px solid #2563eb; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            main { padding: 0 !important; margin: 0 !important; }
            .printable-report { box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0.5in; }
        }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <nav class="no-print sticky top-0 z-50 bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-8">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white"><i data-lucide="monitor"></i></div>
                <div>
                    <h1 class="font-bold text-xl tracking-tight text-slate-900">M-Commerce Corp.</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Operation Department</p>
                </div>
            </div>
            <div class="hidden md:flex gap-6 h-full items-center">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="text-sm font-semibold py-1 transition-all border-b-2 border-transparent">Dashboard</button>
                <button onclick="switchView('trainee-list')" id="nav-trainee-list" class="text-sm font-semibold py-1 transition-all border-b-2 border-transparent">Trainee List</button>
                <button onclick="switchView('settings')" id="nav-settings" class="text-sm font-semibold py-1 transition-all border-b-2 border-transparent">Settings</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6 pb-20">
        <!-- Dashboard View -->
        <div id="dashboard-view" class="space-y-8">
            <div>
                <h2 class="text-3xl font-black text-slate-900">System Dashboard</h2>
                <p class="text-slate-500">Real-time monitoring of operational performance and schedules.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Total Workforce</p>
                    <h3 class="text-3xl font-black text-slate-900" id="dash-total">0</h3>
                </div>
                <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-purple-500">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Active Personnel</p>
                    <h3 class="text-3xl font-black text-slate-900" id="dash-active">0</h3>
                </div>
                <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-emerald-500">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Regular Staff</p>
                    <h3 class="text-3xl font-black text-slate-900" id="dash-regular">0</h3>
                </div>
                <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-rose-500">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Overdue Evals</p>
                    <h3 class="text-3xl font-black text-rose-600" id="dash-overdue">0</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="activity" class="text-blue-500 w-5 h-5"></i>
                        <h4 class="font-black text-slate-900 uppercase text-sm tracking-wider">Recent Activity</h4>
                    </div>
                    <div id="activity-feed" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
                </div>

                <div class="lg:col-span-2 space-y-8">
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="alert-triangle" class="text-rose-500 w-5 h-5"></i>
                            <h4 class="font-black text-slate-900 uppercase text-sm tracking-wider">Overdue Evaluations</h4>
                        </div>
                        <div id="overdue-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="calendar" class="text-emerald-500 w-5 h-5"></i>
                            <h4 class="font-black text-slate-900 uppercase text-sm tracking-wider">Evaluation Queue</h4>
                        </div>
                        <div id="upcoming-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trainee List View -->
        <div id="trainee-list-view" class="hidden space-y-12">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-3xl font-black text-slate-900">Personnel Records</h2>
                    <p class="text-slate-500">Filter and manage all employees in the system.</p>
                </div>
                <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                    <div class="relative w-full md:w-72">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                        <input type="text" id="trainee-search" oninput="renderDashboard()" placeholder="Search by name..." class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                    </div>
                    <button onclick="showAddTraineeModal()" class="bg-slate-900 text-white px-6 py-2 rounded-xl text-sm font-semibold flex items-center justify-center gap-2 hover:bg-black transition-all shadow-lg">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> Add Trainee
                    </button>
                </div>
            </div>

            <div id="sections-container" class="space-y-12">
                <section id="sec-trainee">
                    <div class="border-l-4 border-blue-500 pl-4 mb-6"><h3 class="font-black text-slate-900 uppercase tracking-widest text-xs">Active Trainees</h3></div>
                    <div id="grid-trainee" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="empty-trainee" class="hidden text-center py-10 glass-card rounded-3xl border-dashed border-2"><p class="text-slate-400 italic">No records found.</p></div>
                </section>
                <section id="sec-probationary">
                    <div class="border-l-4 border-purple-500 pl-4 mb-6"><h3 class="font-black text-slate-900 uppercase tracking-widest text-xs">Probationary Period</h3></div>
                    <div id="grid-probationary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="empty-probationary" class="hidden text-center py-10 glass-card rounded-3xl border-dashed border-2"><p class="text-slate-400 italic">No records found.</p></div>
                </section>
                <section id="sec-regular">
                    <div class="border-l-4 border-emerald-500 pl-4 mb-6"><h3 class="font-black text-slate-900 uppercase tracking-widest text-xs">Regular Staff</h3></div>
                    <div id="grid-regular" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="empty-regular" class="hidden text-center py-10 glass-card rounded-3xl border-dashed border-2"><p class="text-slate-400 italic">No records found.</p></div>
                </section>
                <section id="sec-terminated">
                    <div class="border-l-4 border-rose-500 pl-4 mb-6"><h3 class="font-black text-slate-900 uppercase tracking-widest text-xs text-rose-600">Terminated Records</h3></div>
                    <div id="grid-terminated" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 opacity-75"></div>
                    <div id="empty-terminated" class="hidden text-center py-10 glass-card rounded-3xl border-dashed border-2"><p class="text-slate-400 italic">No records found.</p></div>
                </section>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="hidden space-y-8 max-w-2xl">
            <div>
                <h2 class="text-3xl font-black text-slate-900">System Settings</h2>
                <p class="text-slate-500">Manage application data backups and system maintenance.</p>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <div class="glass-card p-8 rounded-3xl space-y-6">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="database"></i></div>
                        <h3 class="text-xl font-bold">Data Management</h3>
                    </div>
                    <p class="text-sm text-slate-500 leading-relaxed">Protect your personnel records by exporting a local backup file. You can restore data on another device or after a system reset.</p>
                    
                    <div class="flex flex-col sm:flex-row gap-4 pt-2">
                        <button onclick="backupData()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-700 transition-all">
                            <i data-lucide="download"></i> Backup Data (JSON)
                        </button>
                        <div class="flex-1 relative">
                            <input type="file" id="restore-input" onchange="restoreData(event)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <button class="w-full bg-slate-100 text-slate-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-200 transition-all border border-slate-200">
                                <i data-lucide="upload"></i> Restore from Backup
                            </button>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-8 rounded-3xl border-2 border-rose-50 space-y-6">
                    <div class="flex items-center gap-3 text-rose-600">
                        <div class="p-2 bg-rose-100 rounded-lg"><i data-lucide="alert-octagon"></i></div>
                        <h3 class="text-xl font-bold">Factory Reset</h3>
                    </div>
                    <p class="text-sm text-slate-500 leading-relaxed">Permanently erase all personnel records and activity logs. This action cannot be undone.</p>
                    <button onclick="showFactoryResetModal()" class="bg-rose-50 text-rose-600 py-3 px-8 rounded-xl font-bold border-2 border-rose-100 hover:bg-rose-600 hover:text-white transition-all w-fit">
                        Clear All System Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Hidden Detail Views -->
        <div id="eval-view" class="hidden max-w-4xl mx-auto space-y-6">
            <div class="flex items-center gap-4">
                <button onclick="switchView('trainee-list')" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="arrow-left"></i></button>
                <h2 class="text-2xl font-bold" id="eval-title">Evaluation Entry</h2>
            </div>
            <div class="glass-card p-8 rounded-3xl shadow-lg space-y-8" id="eval-form-container"></div>
        </div>

        <div id="report-view" class="hidden space-y-8">
            <div class="flex items-center gap-4 no-print">
                <button onclick="switchView('trainee-list')" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="arrow-left"></i></button>
                <h2 class="text-2xl font-bold text-slate-900">Performance Dossier</h2>
            </div>
            <div id="report-content"></div>
        </div>

        <div id="eval-detail-view" class="hidden space-y-8">
            <div class="flex items-center justify-between no-print">
                <button id="back-to-report-btn" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="arrow-left"></i></button>
                <button id="download-eval-pdf" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg"><i data-lucide="download"></i> Download Report</button>
            </div>
            <div id="eval-detail-content" class="printable-report"></div>
        </div>

        <div id="endorsement-view" class="hidden space-y-8">
            <div class="flex items-center justify-between no-print">
                <button id="back-to-report-from-endorse" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="arrow-left"></i></button>
                <button id="download-endorse-pdf" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg"><i data-lucide="download"></i> Download Endorsement</button>
            </div>
            <div id="endorsement-content" class="printable-report"></div>
        </div>

        <div id="termination-view" class="hidden space-y-8">
            <div class="flex items-center justify-between no-print">
                <button id="back-to-report-from-term" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="arrow-left"></i></button>
                <button id="download-term-pdf" class="bg-rose-600 text-white px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg"><i data-lucide="download"></i> Download Notice</button>
            </div>
            <div id="termination-content" class="printable-report"></div>
        </div>
    </main>

    <!-- Modals Backdrop -->
    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/60 hidden z-[60] backdrop-blur-sm flex items-center justify-center p-4">
        
        <!-- Generic Confirmation Modal -->
        <div id="confirm-modal" class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 hidden text-center">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="help-circle" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold mb-2" id="confirm-modal-title">Confirm Action</h3>
            <p class="text-sm text-slate-500 mb-8" id="confirm-modal-message">Are you sure you want to proceed?</p>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all">Cancel</button>
                <button id="generic-confirm-btn" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg transition-all">Proceed</button>
            </div>
        </div>

        <!-- Factory Reset Verification Modal -->
        <div id="factory-reset-modal" class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 hidden text-center border-4 border-rose-100">
            <div class="w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-octagon" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">Security Verification</h3>
            <p class="text-sm text-slate-500 mb-6">This will PERMANENTLY erase all system data. Type <span class="font-black text-rose-600">RESET</span> to confirm.</p>
            <input type="text" id="reset-verify-input" placeholder="Type keyword here..." class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-rose-500 text-center font-bold mb-6">
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all">Cancel</button>
                <button id="confirm-reset-btn" class="flex-1 py-3 bg-rose-600 text-white font-bold rounded-xl shadow-lg transition-all">Execute Wipe</button>
            </div>
        </div>

        <!-- Add/Edit Personnel Modal -->
        <div id="add-trainee-modal" class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" id="trainee-modal-title">Register Personnel</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
            </div>
            <form id="add-trainee-form" class="space-y-4">
                <input type="hidden" name="id">
                <div><label class="block text-sm font-semibold mb-1 text-slate-700">Full Name</label><input type="text" name="name" required class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label class="block text-sm font-semibold mb-1 text-slate-700">Hire Date</label><input type="date" name="hireDate" required class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500"></div>
                <button type="submit" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition-all">Save Record</button>
            </form>
        </div>

        <!-- Termination Reason Modal -->
        <div id="terminate-modal" class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-8 hidden text-center">
            <div class="w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="user-x" class="w-8 h-8"></i></div>
            <h3 class="text-xl font-bold mb-2">Termination Grounds</h3>
            <p class="text-sm text-slate-500 mb-6 italic">Document the formal grounds for contract termination.</p>
            <textarea id="terminate-reason" class="w-full p-4 border border-slate-200 rounded-xl h-32 text-sm focus:ring-2 focus:ring-rose-500 outline-none mb-6" placeholder="Reason for termination..."></textarea>
            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all">Cancel</button>
                <button id="confirm-terminate-btn" class="flex-1 py-3 bg-rose-600 text-white font-bold rounded-xl shadow-lg transition-all">Confirm</button>
            </div>
        </div>

        <!-- Success/Promotion Modal -->
        <div id="congrats-modal" class="bg-white w-full max-w-4xl rounded-[40px] shadow-2xl p-0 overflow-hidden hidden">
            <div id="cert-pdf-wrapper" class="p-[0.1in] bg-white">
                <div id="cert-container" class="certificate-border p-12 text-center space-y-10">
                    <div class="space-y-2">
                        <h4 class="text-blue-900 font-black uppercase tracking-[0.3em] text-xs">M-Commerce Corporation</h4>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Operation Department</p>
                    </div>
                    <div class="space-y-4">
                        <h2 class="cert-title text-6xl font-black text-slate-900">Certificate of Promotion</h2>
                        <p class="text-slate-500 font-medium italic">This honor is officially awarded to</p>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-5xl font-black cert-gold-text underline underline-offset-8 decoration-slate-200" id="cert-name"></h3>
                        <p class="text-slate-500 text-lg">For demonstrating exceptional technical mastery and professionalism,</p>
                        <p class="text-slate-500 text-lg">qualifying for advancement to the role of</p>
                        <p class="text-3xl font-black text-blue-900 uppercase tracking-tighter" id="cert-status"></p>
                    </div>
                    <div class="pt-20 grid grid-cols-3 gap-10">
                        <div class="border-t border-slate-900 pt-3">
                            <p class="text-[9px] font-black uppercase text-slate-400">Date of Award</p>
                            <p class="text-xs font-bold text-slate-900" id="cert-date"></p>
                        </div>
                        <div class="flex justify-center items-center opacity-30"><i data-lucide="award" class="text-blue-900 w-12 h-12"></i></div>
                        <div class="border-t border-slate-900 pt-3"><p class="text-[9px] font-black uppercase text-slate-400">Authorization</p><p class="text-xs font-bold text-slate-900">Operation Mgmt</p></div>
                    </div>
                </div>
            </div>
            <div class="p-8 bg-slate-50 flex justify-end gap-4">
                <button onclick="closeModal()" class="px-8 py-3 text-slate-500 font-bold hover:bg-white rounded-xl transition-all">Close</button>
                <button id="download-cert-pdf" class="px-8 py-3 bg-blue-900 text-white font-bold rounded-xl flex items-center gap-2 shadow-xl"><i data-lucide="download"></i> Download Certificate</button>
            </div>
        </div>
    </div>

    <script>
        // PWA SW
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Failed'));
            });
        }

        let employees = JSON.parse(localStorage.getItem('m_corp_employees')) || [];
        let activityLog = JSON.parse(localStorage.getItem('m_corp_activity')) || [];
        let currentEvalEmployeeId = null;

        // Custom Modal Logic
        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirm-modal-title').innerText = title;
            document.getElementById('confirm-modal-message').innerText = message;
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('generic-confirm-btn').onclick = () => {
                onConfirm();
                closeModal();
            };
            lucide.createIcons();
        }

        function showFactoryResetModal() {
            document.getElementById('reset-verify-input').value = '';
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('factory-reset-modal').classList.remove('hidden');
            document.getElementById('confirm-reset-btn').onclick = () => {
                const keyword = document.getElementById('reset-verify-input').value.trim();
                if (keyword === 'RESET') {
                    localStorage.clear();
                    employees = [];
                    activityLog = [];
                    location.reload();
                } else {
                    showNotification("Invalid keyword.");
                }
            };
            lucide.createIcons();
        }

        function getStatusClass(s) {
            switch(s) {
                case 'Trainee': return 'bg-blue-50 text-blue-600 border border-blue-100';
                case 'Probationary': return 'bg-purple-50 text-purple-600 border border-purple-100';
                case 'Regular': return 'bg-emerald-50 text-emerald-600 border border-emerald-100';
                default: return 'bg-rose-50 text-rose-600 border border-rose-100';
            }
        }

        const EVAL_STRUCTURE = [
            { category: "Part I - OBS Setup & Troubleshooting", sections: [
                { title: "OBS Livescene & Source", questions: [
                    { q: "Parts of Livescene (Basic & Advance)", ans: "Basic: Header, Sticker, Podium, Background. Advance: Logos, Campaign Header, Frame, Stickers." },
                    { q: "Mostly used Source in OBS", ans: "Image, Media Source, Video Capture (Basic) + Color Source, Text (Advance)" },
                    { q: "Proper Microphone Setup", ans: "Input audio source directly on OBS settings" }
                ]},
                { title: "OBS Settings", questions: [
                    { q: "OBS Canvas Settings", ans: "1080x1920 (Aspect Ratio 9:16)" },
                    { q: "OBS Encoder & Rate Control", ans: "Nvidia NVEC H264, CBR (Constant) / VBR (Variable)" }
                ]}
            ]},
            { category: "Part II - Camera Setup", sections: [
                { title: "Technical Settings", questions: [
                    { q: "HDMI & Power Save Settings", ans: "Power Save Always Off, HDMI 2160p/1080p @ 60p" },
                    { q: "Camera Cleaning", ans: "Brush outer part, Air pump for dust, Wet/Dry wipes for lens" }
                ]}
            ]},
            { category: "Part III - Skills & Performance", sections: [
                { title: "Soft Skills", questions: [
                    { q: "Composure & Emotional Control", ans: "Calm under pressure, no panic during malfunctions." },
                    { q: "Clear Communication", ans: "Short, direct instructions without rushing." },
                    { q: "Technical Speed", ans: "Overall efficiency of technical tasks (Trainer Graded)." }
                ]}
            ]}
        ];

        window.onload = () => {
            switchView('dashboard');
        };

        function saveData() { 
            localStorage.setItem('m_corp_employees', JSON.stringify(employees)); 
            localStorage.setItem('m_corp_activity', JSON.stringify(activityLog));
        }

        function logActivity(type, message, empName) {
            activityLog.unshift({ type, message, empName, date: new Date().toLocaleString(), id: Date.now() });
            if (activityLog.length > 50) activityLog.pop();
            saveData();
        }

        function switchView(view) {
            document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`${view}-view`);
            if (target) target.classList.remove('hidden');
            document.querySelectorAll('nav button[id^="nav-"]').forEach(btn => btn.classList.remove('nav-link-active'));
            const navBtn = document.getElementById(`nav-${view}`);
            if (navBtn) navBtn.classList.add('nav-link-active');
            renderDashboard();
            lucide.createIcons();
            window.scrollTo(0,0);
        }

        function closeModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.querySelectorAll('#modal-backdrop > div').forEach(el => el.classList.add('hidden'));
        }

        function showAddTraineeModal() {
            document.getElementById('trainee-modal-title').innerText = 'Register Personnel';
            const form = document.getElementById('add-trainee-form');
            form.reset();
            form.querySelector('input[name="id"]').value = '';
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('add-trainee-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function showEditModal(id) {
            const emp = employees.find(e => e.id == id);
            if (!emp) return;
            document.getElementById('trainee-modal-title').innerText = 'Update Personnel Record';
            const form = document.getElementById('add-trainee-form');
            form.querySelector('input[name="id"]').value = emp.id;
            form.querySelector('input[name="name"]').value = emp.name;
            form.querySelector('input[name="hireDate"]').value = emp.hireDate;
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('add-trainee-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function confirmDelete(id) {
            const emp = employees.find(e => e.id == id);
            if (!emp) return;
            showConfirmModal(
                "Delete Record", 
                `Are you sure you want to permanently delete the dossier for ${emp.name}? This cannot be undone.`, 
                () => {
                    employees = employees.filter(e => e.id != id);
                    logActivity('delete', 'Record deleted permanently', emp.name);
                    saveData(); 
                    renderDashboard();
                }
            );
        }

        document.getElementById('add-trainee-form').onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const id = formData.get('id');
            const name = formData.get('name');
            const hireDate = formData.get('hireDate');

            if (id) {
                const emp = employees.find(e => e.id == id);
                if (emp) {
                    emp.name = name;
                    emp.hireDate = hireDate;
                    logActivity('edit', 'Profile updated', name);
                }
            } else {
                employees.push({
                    id: Date.now(),
                    name,
                    hireDate,
                    status: 'Trainee',
                    evaluations: [],
                    achievements: [],
                    phaseStartIdx: 0,
                    phaseLimit: 3
                });
                logActivity('new_hire', 'Personnel added', name);
            }
            saveData(); renderDashboard(); closeModal();
        };

        function calculateNextDate(hireDate, count) {
            const d = new Date(hireDate);
            d.setMonth(d.getMonth() + count + 1);
            return d.toLocaleDateString();
        }

        function renderDashboard() {
            const today = new Date(); today.setHours(0,0,0,0);
            const searchQuery = document.getElementById('trainee-search').value.toLowerCase();

            let overdueCount = 0, overdueItems = [], upcomingItems = [];
            const filteredEmployees = employees.filter(e => e.name.toLowerCase().includes(searchQuery));

            employees.forEach(emp => {
                if (emp.status === 'Regular' || emp.status === 'Terminated') return;
                const nextDateStr = calculateNextDate(emp.hireDate, emp.evaluations.length);
                const nextDate = new Date(nextDateStr);
                
                if (nextDate < today) {
                    overdueCount++;
                    const diffDays = Math.ceil(Math.abs(today - nextDate) / (1000 * 60 * 60 * 24));
                    overdueItems.push({ name: emp.name, date: nextDateStr, days: diffDays, status: emp.status });
                } else {
                    upcomingItems.push({ name: emp.name, date: nextDateStr, status: emp.status });
                }
            });

            document.getElementById('dash-total').innerText = employees.length;
            document.getElementById('dash-active').innerText = employees.filter(e => e.status !== 'Terminated' && e.status !== 'Regular').length;
            document.getElementById('dash-regular').innerText = employees.filter(e => e.status === 'Regular').length;
            document.getElementById('dash-overdue').innerText = overdueCount;

            const overdueList = document.getElementById('overdue-list');
            if(overdueItems.length === 0) overdueList.innerHTML = `<div class="col-span-full py-10 glass-card rounded-3xl border-dashed border-2 text-center text-xs text-slate-400 uppercase tracking-widest">No assessments overdue.</div>`;
            else {
                overdueItems.sort((a,b) => b.days - a.days);
                overdueList.innerHTML = overdueItems.map(item => `<div class="glass-card p-4 rounded-2xl border-l-4 border-l-rose-500 flex justify-between items-center"><div><p class="font-black text-sm text-slate-900">${item.name}</p><p class="text-[9px] font-bold text-slate-400 uppercase">${item.status}</p></div><div class="text-right"><p class="text-[9px] font-black text-rose-600 uppercase">Late ${item.days}d</p><p class="text-[10px] font-bold text-slate-500">${item.date}</p></div></div>`).join('');
            }

            const upcomingList = document.getElementById('upcoming-list');
            upcomingItems.sort((a,b) => new Date(a.date) - new Date(b.date));
            upcomingList.innerHTML = upcomingItems.slice(0, 4).map(item => `<div class="glass-card p-4 rounded-2xl border-l-4 border-l-blue-500 flex justify-between items-center"><div><p class="font-black text-sm text-slate-900">${item.name}</p><p class="text-[9px] font-bold text-slate-400 uppercase">${item.status}</p></div><div class="text-right"><p class="text-[9px] font-black text-blue-600 uppercase">Scheduled</p><p class="text-[10px] font-bold text-slate-500">${item.date}</p></div></div>`).join('') || `<div class="col-span-full py-10 glass-card rounded-3xl border-dashed border-2 text-center text-xs text-slate-400">Empty queue.</div>`;

            document.getElementById('activity-feed').innerHTML = activityLog.slice(0, 15).map(log => `<div class="p-3 bg-white border rounded-2xl flex items-start gap-3"><div class="flex-grow"><p class="text-[10px] font-black text-slate-800 uppercase">${log.empName}</p><p class="text-[9px] text-slate-500">${log.message}</p></div><p class="text-[8px] text-slate-400 font-bold">${log.date.split(',')[0]}</p></div>`).join('') || '<p class="text-xs italic text-slate-400">No logs found.</p>';

            const grids = { 'Trainee': 'grid-trainee', 'Probationary': 'grid-probationary', 'Regular': 'grid-regular', 'Terminated': 'grid-terminated' };
            Object.values(grids).forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = ''; });
            
            filteredEmployees.forEach(emp => {
                const grid = document.getElementById(grids[emp.status]);
                if(!grid) return;
                const phaseEvals = emp.evaluations.slice(emp.phaseStartIdx || 0);
                const isCycleComplete = phaseEvals.length >= (emp.phaseLimit || 3);
                const avg = phaseEvals.length ? (phaseEvals.reduce((a,c) => a+parseFloat(c.score),0)/phaseEvals.length).toFixed(1) : 0;
                
                const card = document.createElement('div');
                card.className = 'glass-card p-6 rounded-3xl shadow-sm border-t-8 flex flex-col ' + 
                                (emp.status === 'Trainee' ? 'border-t-blue-500' : emp.status === 'Probationary' ? 'border-t-purple-500' : emp.status === 'Regular' ? 'border-t-emerald-500' : 'border-t-rose-500');
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div class="max-w-[70%]"><h3 class="font-black text-lg text-slate-900 break-words">${emp.name}</h3><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Hired ${emp.hireDate}</p></div>
                        <div class="flex flex-col items-end gap-2">
                             <span class="px-2 py-0.5 rounded-full text-[8px] font-black uppercase tracking-widest ${getStatusClass(emp.status)}">${emp.status}</span>
                             <div class="flex gap-1 no-print">
                                <button onclick="showEditModal(${emp.id})" class="p-1 hover:bg-blue-50 text-blue-500 rounded-lg transition-all"><i data-lucide="edit-3" class="w-3 h-3"></i></button>
                                <button onclick="confirmDelete(${emp.id})" class="p-1 hover:bg-rose-50 text-rose-500 rounded-lg transition-all"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                             </div>
                        </div>
                    </div>
                    <div class="space-y-4 flex-grow">
                        ${emp.status !== 'Regular' && emp.status !== 'Terminated' ? `
                            <div class="space-y-1">
                                <div class="flex justify-between text-[10px] font-black uppercase"><span class="text-slate-400">Progress</span><span class="text-blue-600">${phaseEvals.length}/${emp.phaseLimit || 3} Mos</span></div>
                                <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-blue-600 transition-all duration-500" style="width: ${(phaseEvals.length/(emp.phaseLimit||3))*100}%"></div></div>
                            </div>
                        ` : ''}
                        ${isCycleComplete && emp.status !== 'Regular' && emp.status !== 'Terminated' ? `
                            <div class="bg-blue-50 border border-blue-100 p-3 rounded-2xl">
                                <p class="text-[9px] font-black text-blue-600 uppercase mb-2 text-center">Cycle Finished (Avg: ${avg}%)</p>
                                <div class="grid grid-cols-1 gap-2">
                                    <button onclick="handleDecision(${emp.id}, 'promote')" class="py-2 bg-emerald-600 text-white rounded-lg text-[10px] font-black uppercase hover:bg-emerald-700 flex items-center justify-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> Promote</button>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button onclick="handleDecision(${emp.id}, 'extend')" class="py-2 bg-amber-500 text-white rounded-lg text-[10px] font-black uppercase hover:bg-amber-600 flex items-center justify-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Extend</button>
                                        <button onclick="confirmTermination(${emp.id})" class="py-2 bg-rose-600 text-white rounded-lg text-[10px] font-black uppercase hover:bg-rose-700 flex items-center justify-center gap-1"><i data-lucide="user-x" class="w-3 h-3"></i> Terminate</button>
                                    </div>
                                </div>
                            </div>
                        ` : emp.status === 'Terminated' ? `<p class="text-[9px] italic text-rose-800 line-clamp-2 uppercase font-bold tracking-tight bg-rose-50 p-2 rounded-xl border border-rose-100">Decision: ${emp.terminationReason}</p>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-6">
                        ${!isCycleComplete && emp.status !== 'Regular' && emp.status !== 'Terminated' ? `<button onclick="startEvaluation(${emp.id})" class="col-span-1 py-3 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-wider shadow-sm"><i data-lucide="clipboard-check" class="w-3 h-3 inline mr-1"></i> Assess M${phaseEvals.length+1}</button><button onclick="confirmTermination(${emp.id})" class="col-span-1 py-3 border border-rose-100 text-rose-500 rounded-xl text-[10px] font-black uppercase">Terminate</button>` : ''}
                        <button onclick="viewReport(${emp.id})" class="col-span-2 py-3 border border-slate-200 text-slate-600 rounded-xl text-[10px] font-black uppercase hover:bg-slate-50 transition-all flex items-center justify-center gap-2"><i data-lucide="file-text" class="w-3 h-3"></i> Personnel Dossier</button>
                    </div>
                `;
                grid.appendChild(card);
            });
            ['trainee', 'probationary', 'regular', 'terminated'].forEach(s => { 
                const g = document.getElementById(`grid-${s}`); 
                const e = document.getElementById(`empty-${s}`); 
                if(g && e) g.children.length === 0 ? e.classList.remove('hidden') : e.classList.add('hidden'); 
            });
            lucide.createIcons();
        }

        function startEvaluation(id) {
            currentEvalEmployeeId = id;
            const emp = employees.find(e => e.id == id);
            if (!emp) return;
            document.getElementById('eval-title').innerText = `${emp.name}`;
            const container = document.getElementById('eval-form-container');
            container.innerHTML = '';
            
            EVAL_STRUCTURE.forEach((cat, catIdx) => {
                const catDiv = document.createElement('div');
                catDiv.className = "space-y-6";
                catDiv.innerHTML = `<h3 class="text-sm font-black text-blue-600 uppercase tracking-widest border-b pb-2">${cat.category}</h3>`;
                cat.sections.forEach((sec, secIdx) => {
                    const secDiv = document.createElement('div');
                    secDiv.className = "space-y-4 ml-2";
                    secDiv.innerHTML = `<h4 class="font-bold text-slate-800 text-sm">${sec.title}</h4>`;
                    sec.questions.forEach((q, qIdx) => {
                        const qId = `q_${catIdx}_${secIdx}_${qIdx}`;
                        const qDiv = document.createElement('div');
                        qDiv.className = "p-5 rounded-2xl bg-white border border-slate-100 shadow-sm space-y-4 ml-2";
                        qDiv.innerHTML = `
                            <p class="text-sm font-semibold text-slate-700">${q.q}</p>
                            <div class="flex flex-col md:flex-row gap-4">
                                <div class="flex-1 bg-blue-50/50 p-3 rounded-xl border border-blue-100/50">
                                    <p class="text-[10px] text-blue-800 font-medium leading-relaxed">${q.ans}</p>
                                </div>
                                <div class="w-full md:w-48 flex flex-col justify-center items-center bg-slate-50 rounded-xl p-3 border border-slate-100">
                                    <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Grade (1-5)</p>
                                    <div class="flex gap-1.5">
                                        ${[1,2,3,4,5].map(v => `<button type="button" onclick="selectScore('${qId}', ${v})" id="${qId}_btn_${v}" class="score-btn w-7 h-7 rounded-lg border border-slate-200 bg-white text-xs font-black transition-all hover:bg-blue-50">${v}</button>`).join('')}
                                    </div>
                                    <input type="hidden" id="${qId}" value="0">
                                </div>
                            </div>`;
                        secDiv.appendChild(qDiv);
                    });
                    catDiv.appendChild(secDiv);
                });
                container.appendChild(catDiv);
            });
            const actionDiv = document.createElement('div');
            actionDiv.className = "pt-10 flex justify-center";
            actionDiv.innerHTML = `<button onclick="submitEvaluation()" class="w-full max-w-md bg-slate-900 text-white py-4 rounded-2xl font-black uppercase hover:bg-black transition-all shadow-xl flex items-center justify-center gap-2"><i data-lucide="save"></i> Submit Assessment</button>`;
            container.appendChild(actionDiv);
            switchView('eval');
        }

        function selectScore(qId, val) {
            const input = document.getElementById(qId);
            input.value = val;
            for(let i=1; i<=5; i++) {
                const btn = document.getElementById(`${qId}_btn_${i}`);
                btn.className = "score-btn w-7 h-7 rounded-lg border border-slate-200 bg-white text-xs font-black transition-all hover:bg-blue-50";
            }
            const activeBtn = document.getElementById(`${qId}_btn_${val}`);
            activeBtn.className = "score-btn w-7 h-7 rounded-lg border border-blue-600 bg-blue-600 text-white text-xs font-black transition-all";
        }

        function submitEvaluation() {
            const emp = employees.find(e => e.id == currentEvalEmployeeId);
            if (!emp) return;
            let responses = [], totalS = 0, totalP = 0, incomplete = false;
            EVAL_STRUCTURE.forEach((cat, catIdx) => { 
                cat.sections.forEach((sec, secIdx) => { 
                    sec.questions.forEach((q, qIdx) => {
                        const val = parseInt(document.getElementById(`q_${catIdx}_${secIdx}_${qIdx}`).value);
                        if(val === 0) incomplete = true;
                        responses.push({ q: q.q, cat: cat.category, score: val });
                        totalS += val; totalP += 5;
                    });
                });
            });
            if(incomplete) { showNotification("Assessment incomplete."); return; }
            const score = ((totalS / totalP) * 100).toFixed(1);
            emp.evaluations.push({ 
                id: Date.now(), 
                phaseMonth: emp.evaluations.slice(emp.phaseStartIdx || 0).length + 1, 
                type: emp.status, 
                score, 
                date: new Date().toLocaleDateString(), 
                details: responses 
            });
            logActivity('eval', `Assessment: ${score}%`, emp.name);
            saveData(); renderDashboard(); switchView('trainee-list');
        }

        function handleDecision(id, action) {
            const emp = employees.find(e => e.id == id);
            if (!emp) return;
            if(action === 'promote') {
                const oldS = emp.status, newS = oldS === 'Trainee' ? 'Probationary' : 'Regular';
                const relevantEvals = emp.evaluations.slice(emp.phaseStartIdx || 0);
                emp.achievements.push({ id: Date.now(), title: `Promoted to ${newS}`, date: new Date().toLocaleDateString(), type: newS, fromStatus: oldS, evaluations: [...relevantEvals] });
                emp.status = newS; emp.phaseStartIdx = emp.evaluations.length; emp.phaseLimit = 3;
                logActivity('promote', `Advanced to ${newS}`, emp.name);
                saveData(); renderDashboard(); showCongrats(emp);
            } else if(action === 'extend') {
                emp.phaseLimit = (emp.phaseLimit || 3) + 1;
                logActivity('extend', `Extension added (+1 Mo)`, emp.name);
                saveData(); renderDashboard(); showNotification("Extended.");
            }
        }

        function showCongrats(emp) {
            document.getElementById('cert-name').innerText = emp.name;
            document.getElementById('cert-status').innerText = emp.status;
            document.getElementById('cert-date').innerText = new Date().toLocaleDateString();
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('congrats-modal').classList.remove('hidden');
            document.getElementById('download-cert-pdf').onclick = () => downloadPDF('cert-pdf-wrapper', `${emp.name}_Certificate.pdf`);
            lucide.createIcons();
        }

        function viewReport(id) {
            const emp = employees.find(e => e.id == id);
            const container = document.getElementById('report-content');
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="glass-card p-8 rounded-3xl text-center shadow-md border-b-4 border-b-blue-600">
                            <div class="w-24 h-24 bg-blue-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 font-black text-3xl shadow-lg uppercase">${emp.name.charAt(0)}</div>
                            <h3 class="text-2xl font-black text-slate-900">${emp.name}</h3>
                            <span class="px-4 py-1.5 bg-slate-100 rounded-full text-[10px] font-black uppercase tracking-widest text-slate-500">${emp.status}</span>
                            ${emp.status === 'Terminated' ? `<div class="mt-4"><button onclick="generateTerminationLetter(${emp.id})" class="w-full py-2 bg-rose-600 text-white rounded-xl text-[10px] font-black uppercase shadow-lg">Notice of Termination (PDF)</button></div>` : ''}
                        </div>
                        <div class="glass-card p-6 rounded-3xl shadow-sm">
                            <h4 class="font-black text-slate-900 mb-6 flex items-center gap-2 text-xs uppercase tracking-widest"><i data-lucide="award" class="w-4 h-4 text-amber-500"></i> Career Milestones</h4>
                            <div class="space-y-4">
                                ${emp.achievements.map(a => `
                                    <div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl space-y-3">
                                        <p class="text-xs font-black text-slate-800">${a.title}</p>
                                        <div class="flex gap-2">
                                            <button onclick="viewCardFromAchievement(${emp.id}, ${a.id})" class="flex-1 py-1.5 bg-white border border-amber-200 text-amber-600 rounded-lg text-[10px] font-bold uppercase hover:bg-amber-50">Certificate</button>
                                            <button onclick="generateEndorsementLetter(${emp.id}, ${a.id})" class="flex-1 py-1.5 bg-amber-500 text-white rounded-lg text-[10px] font-bold uppercase hover:bg-amber-600">Endorsement</button>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-xs text-slate-400 italic">No milestones found.</p>'}
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div class="glass-card p-8 rounded-3xl shadow-sm">
                            <h4 class="font-black text-slate-900 mb-6 flex items-center gap-2 text-xs uppercase tracking-widest"><i data-lucide="activity" class="w-4 h-4 text-blue-500"></i> Performance Logs</h4>
                            <div class="space-y-3">
                                ${emp.evaluations.slice().reverse().map(ev => `
                                    <div onclick="showEvalDetail(${emp.id}, ${ev.id})" class="flex items-center justify-between p-5 bg-slate-50/50 rounded-2xl border border-slate-100 cursor-pointer hover:bg-white transition-all group">
                                        <div class="flex items-center gap-4">
                                            <div class="bg-white p-3 rounded-xl shadow-sm text-[10px] font-black uppercase text-blue-600">PH${ev.phaseMonth}</div>
                                            <div><p class="text-xs font-black text-slate-700 uppercase">${ev.type}</p><p class="text-[10px] text-slate-400 font-bold">${ev.date}</p></div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xl font-black ${ev.score >= 80 ? 'text-emerald-600' : 'text-rose-600'}">${ev.score}%</p>
                                            <span class="text-[8px] font-black uppercase text-blue-500">View Breakdown</span>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-xs italic text-slate-400 text-center py-10">No records found.</p>'}
                            </div>
                        </div>
                    </div>
                </div>`;
            switchView('report');
        }

        function showEvalDetail(empId, evalId) {
            const emp = employees.find(e => e.id == empId), ev = emp.evaluations.find(e => e.id == evalId);
            const container = document.getElementById('eval-detail-content');
            if (!container || !ev) return;
            const weaknesses = ev.details.filter(d => d.score <= 2), neutral = ev.details.filter(d => d.score === 3), strengths = ev.details.filter(d => d.score >= 4);

            container.innerHTML = `
                <div class="space-y-12">
                    <div class="flex justify-between items-start border-b-8 border-slate-900 pb-8 uppercase font-black tracking-tighter">
                        <div>
                            <h1 class="text-2xl">M-Commerce Corporation</h1>
                            <p class="text-sm font-bold text-blue-600 uppercase tracking-widest">Performance Evaluation Dossier</p>
                            <p class="text-[10px] text-slate-400 font-black mt-2">Document ID: ASSESS-${ev.id}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-slate-400 uppercase">Weighted Final Grade</p>
                            <p class="text-7xl text-slate-900 leading-none">${ev.score}%</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-6 bg-slate-50 p-6 rounded-3xl border border-slate-200 text-[10px] uppercase font-black">
                        <div><p class="text-slate-400 mb-1">Subject Personnel</p><p class="text-slate-900">${emp.name}</p></div>
                        <div><p class="text-slate-400 mb-1">Assessment Date</p><p class="text-slate-900">${ev.date}</p></div>
                        <div><p class="text-slate-400 mb-1">Functional Group</p><p class="text-slate-900">Operations</p></div>
                        <div><p class="text-slate-400 mb-1">Phase Status</p><p class="text-slate-900">${ev.type} | Mo. ${ev.phaseMonth}</p></div>
                    </div>

                    <div class="space-y-4">
                        <h2 class="text-xs font-black uppercase tracking-widest text-slate-900 border-l-4 border-slate-900 pl-3">Executive Summary of Performance</h2>
                        <div class="grid grid-cols-3 gap-6 no-break">
                            <div class="space-y-4">
                                <h4 class="font-black text-rose-600 text-[9px] uppercase tracking-wider">Deficiency Areas (1-2)</h4>
                                <div class="space-y-2">${weaknesses.map(w => `<div class="p-4 bg-rose-50 rounded-2xl border border-rose-100 text-[9px] font-semibold text-rose-800"><p>${w.q}</p></div>`).join('') || '<p class="text-[9px] italic text-slate-400">No critical deficiencies identified.</p>'}</div>
                            </div>
                            <div class="space-y-4">
                                <h4 class="font-black text-blue-600 text-[9px] uppercase tracking-wider">Satisfactory Benchmarks (3)</h4>
                                <div class="space-y-2">${neutral.map(n => `<div class="p-4 bg-blue-50 rounded-2xl border border-blue-100 text-[9px] font-semibold text-blue-800"><p>${n.q}</p></div>`).join('') || '<p class="text-[9px] italic text-slate-400">No neutral benchmarks logged.</p>'}</div>
                            </div>
                            <div class="space-y-4">
                                <h4 class="font-black text-emerald-600 text-[9px] uppercase tracking-wider">Proficiency Strengths (4-5)</h4>
                                <div class="space-y-2">${strengths.map(s => `<div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100 text-[9px] font-semibold text-emerald-800"><p>${s.q}</p></div>`).join('') || '<p class="text-[9px] italic text-slate-400">No exceptional proficiencies identified.</p>'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                         <h2 class="text-xs font-black uppercase tracking-widest text-slate-900 border-l-4 border-slate-900 pl-3">Comprehensive Technical Breakdown</h2>
                        <table class="w-full text-left text-[10px] border-collapse no-break">
                            <thead><tr class="bg-slate-900 text-white"><th class="p-4 border border-slate-700 uppercase tracking-widest">Technical Assessment Indicator</th><th class="p-4 border border-slate-700 text-right uppercase tracking-widest">Metric Score</th></tr></thead>
                            <tbody>${ev.details.map(d => `<tr class="no-break"><td class="p-4 border border-slate-200 font-bold text-slate-700">${d.q}<br><span class="text-[8px] font-black text-slate-400 uppercase">${d.cat}</span></td><td class="p-4 border border-slate-200 text-right font-black text-blue-600">${d.score} / 5.0</td></tr>`).join('')}</tbody>
                        </table>
                    </div>

                    <div class="pt-24 grid grid-cols-2 gap-y-20 gap-x-12 px-6 no-break font-black text-[8px] tracking-[0.2em] text-slate-400 text-center uppercase">
                        <div class="border-t-2 border-slate-900 pt-4 text-slate-900">Evaluated Personnel Signature</div>
                        <div class="border-t-2 border-slate-300 pt-4">Technical Trainer Authorization</div>
                        <div class="border-t-2 border-slate-300 pt-4">Operational Lead Oversight</div>
                        <div class="border-t-2 border-slate-300 pt-4">Department Management Approval</div>
                    </div>
                </div>`;
            document.getElementById('back-to-report-btn').onclick = () => viewReport(empId);
            document.getElementById('download-eval-pdf').onclick = () => downloadPDF('eval-detail-content', `${emp.name}_Report_M${ev.phaseMonth}.pdf`);
            switchView('eval-detail');
            lucide.createIcons();
        }

        function generateEndorsementLetter(empId, achievementId) {
            const emp = employees.find(e => e.id == empId), a = emp.achievements.find(ach => ach.id == achievementId);
            const container = document.getElementById('endorsement-content');
            const avg = (a.evaluations.reduce((acc, curr) => acc + parseFloat(curr.score), 0) / a.evaluations.length).toFixed(1);

            container.innerHTML = `
                <div class="space-y-12">
                    <div class="flex justify-between items-start border-b-2 border-slate-100 pb-10">
                        <div>
                            <h1 class="text-2xl font-black text-slate-900 uppercase">M-Commerce Corporation</h1>
                            <p class="text-xs text-slate-500 font-black uppercase tracking-widest mt-1">Operations & Workforce Management Division</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-slate-900 uppercase">Date: ${a.date}</p>
                            <p class="text-[9px] text-slate-400 font-black uppercase tracking-tighter">Reference: ENDORSE-${a.id}</p>
                        </div>
                    </div>

                    <div class="space-y-8 text-slate-800">
                        <div class="font-black text-sm uppercase tracking-wider text-slate-900">
                            <p>Subject: Formal Endorsement for Professional Advancement</p>
                        </div>

                        <div class="space-y-6 text-sm leading-relaxed text-justify text-slate-700">
                            <p>I am writing to formally submit the professional endorsement of <strong>${emp.name}</strong> for advancement to the role of <strong>${a.type}</strong> within the M-Commerce Corporation operational structure. This recommendation follows a comprehensive and rigorous period of evaluation and technical observation.</p>
                            
                            <p>During the <strong>${a.fromStatus}</strong> phase, <strong>${emp.name}</strong> has consistently demonstrated a high degree of technical mastery, professional integrity, and operational efficiency. Our internal tracking metrics indicate a cumulative performance score of <strong>${avg}%</strong>, which is significantly above the required satisfactory threshold for professional advancement.</p>
                            
                            <p>The candidate has shown exceptional competency in high-pressure troubleshooting scenarios, OBS environment management, and camera technical configurations. Beyond technical skills, their professional conduct and clear communication have contributed positively to our functional environment.</p>

                            <p>Based on these consistent performance results, we have total confidence in their ability to handle the increased responsibilities associated with the role of <strong>${a.type}</strong>. We request that the necessary administrative updates be executed to formalize this promotion effective immediately.</p>
                        </div>
                    </div>

                    <div class="page-break pt-12">
                        <h2 class="text-xs font-black uppercase tracking-[0.2em] mb-8 text-center text-slate-400">Performance Data Annex</h2>
                        <table class="w-full text-left text-[11px] border-collapse border border-slate-200">
                            <thead><tr class="bg-slate-900 text-white"><th class="p-4 border border-slate-700 uppercase tracking-widest">Assessment Period</th><th class="p-4 border border-slate-700 uppercase tracking-widest">Phase Category</th><th class="p-4 border border-slate-700 text-right uppercase tracking-widest">Metric Score</th></tr></thead>
                            <tbody>
                                ${a.evaluations.map(ev => `<tr class="bg-white"><td class="p-4 border border-slate-200 font-bold">Month ${ev.phaseMonth}</td><td class="p-4 border border-slate-200 uppercase">${ev.type}</td><td class="p-4 border border-slate-200 text-right font-black text-blue-600">${ev.score}%</td></tr>`).join('')}
                                <tr class="bg-slate-50 font-black"><td colspan="2" class="p-5 border border-slate-200 text-right uppercase tracking-widest text-slate-600">Phase Achievement Average</td><td class="p-5 border border-slate-200 text-right text-blue-600 text-xl">${avg}%</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="pt-32 grid grid-cols-2 gap-y-20 gap-x-12 px-6 no-break font-black text-[8px] tracking-[0.2em] text-slate-400 text-center uppercase">
                        <div class="border-t-2 border-slate-300 pt-4">Training Lead Signature</div>
                        <div class="border-t-2 border-slate-300 pt-4">Operations Manager Approval</div>
                        <div class="border-t-2 border-slate-300 pt-4">HR Records Acknowledgment</div>
                        <div class="border-t-2 border-slate-300 pt-4">Candidate Confirmation</div>
                    </div>
                </div>`;
            document.getElementById('back-to-report-from-endorse').onclick = () => viewReport(empId);
            document.getElementById('download-endorse-pdf').onclick = () => downloadPDF('endorsement-content', `${emp.name}_Endorsement.pdf`);
            switchView('endorsement');
        }

        function generateTerminationLetter(id) {
            const emp = employees.find(e => e.id == id);
            const container = document.getElementById('termination-content');
            container.innerHTML = `
                <div class="space-y-12">
                    <div class="flex justify-between items-start border-b-2 border-slate-200 pb-10">
                        <div>
                            <h1 class="text-2xl font-black text-slate-900 uppercase">M-Commerce Corporation</h1>
                            <p class="text-xs text-slate-500 font-black uppercase tracking-widest mt-1">Human Resources & Operational Integrity</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-slate-900 uppercase">Effective Date: ${emp.terminationDate}</p>
                            <p class="text-[9px] text-slate-400 font-black uppercase tracking-tighter">REF: NOTICE-TERM-${emp.id}</p>
                        </div>
                    </div>

                    <div class="space-y-8 text-slate-800">
                        <div class="font-black text-sm uppercase tracking-wider text-slate-900">
                            <p>Private & Confidential</p>
                            <p>To: ${emp.name}</p>
                            <p class="mt-4">Subject: Notice of Contract Termination</p>
                        </div>

                        <div class="space-y-6 text-sm leading-relaxed text-justify text-slate-700">
                            <p>Dear <strong>${emp.name}</strong>,</p>
                            
                            <p>This correspondence serves as a formal and final notification regarding the termination of your employment relationship with M-Commerce Corporation, effective immediately as of <strong>${emp.terminationDate}</strong>.</p>
                            
                            <p>This decision follows a thorough administrative review of your professional dossier and the comprehensive performance data gathered during your assessment period. After careful consideration, the Management has concluded that your current technical trajectory and operational conduct do not meet the standards required for the long-term objectives of the Operations Department. This action is taken based on the following specific administrative grounds:</p>
                            
                            <div class="p-10 bg-rose-50 border-l-8 border-rose-500 rounded-r-[32px] italic text-rose-900 shadow-sm leading-relaxed text-xs font-medium">
                                "${emp.terminationReason}"
                            </div>

                            <p>As part of this separation process, all corporate credentials, digital security access, and professional authorizations associated with your personnel record are revoked effective immediately. You are requested to finalize any outstanding administrative clearances with the Department Lead before departure.</p>

                            <p>This decision is final and has been executed to maintain the integrity and high performance standards of M-Commerce Corporation. We wish you success in your future professional endeavors.</p>
                        </div>
                    </div>

                    <div class="pt-32 grid grid-cols-2 gap-y-20 gap-x-12 px-6 no-break font-black text-[8px] tracking-[0.2em] text-slate-400 text-center uppercase">
                        <div class="border-t-2 border-slate-900 pt-4 text-slate-900">Issuing Authority (Ops Management)</div>
                        <div class="border-t-2 border-slate-300 pt-4">HR Department Oversight</div>
                        <div class="border-t-2 border-slate-300 pt-4">Witness Signature</div>
                        <div class="border-t-2 border-slate-300 pt-4">Acknowledged by Recipient</div>
                    </div>
                </div>`;
            document.getElementById('back-to-report-from-term').onclick = () => viewReport(id);
            document.getElementById('download-term-pdf').onclick = () => downloadPDF('termination-content', `${emp.name}_Termination_Notice.pdf`);
            switchView('termination');
        }

        async function downloadPDF(elementId, filename) {
            const element = document.getElementById(elementId);
            const opt = { 
                margin: [0.3, 0.3, 0.3, 0.3], 
                filename, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, useCORS: true, letterRendering: true, backgroundColor: '#ffffff' }, 
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
            };
            showNotification("Compiling PDF...");
            try { await html2pdf().set(opt).from(element).save(); } catch (e) { showNotification("Export failed."); }
        }

        function viewCardFromAchievement(empId, achId) {
            const emp = employees.find(e => e.id == empId), a = emp.achievements.find(ach => ach.id == achId);
            document.getElementById('cert-name').innerText = emp.name;
            document.getElementById('cert-status').innerText = a.type;
            document.getElementById('cert-date').innerText = a.date;
            document.getElementById('download-cert-pdf').onclick = () => downloadPDF('cert-pdf-wrapper', `${emp.name}_Certificate.pdf`);
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('congrats-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function confirmTermination(id) {
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('terminate-modal').classList.remove('hidden');
            document.getElementById('confirm-terminate-btn').onclick = () => {
                const r = document.getElementById('terminate-reason').value;
                if(!r.trim()) { showNotification("Reason required."); return; }
                const emp = employees.find(e => e.id == id);
                if (emp) {
                    emp.status = 'Terminated'; emp.terminationReason = r; emp.terminationDate = new Date().toLocaleDateString();
                    logActivity('term', `Termination: ${r}`, emp.name);
                    saveData(); renderDashboard(); closeModal();
                }
            };
            lucide.createIcons();
        }

        function backupData() {
            const data = { employees, activityLog, version: "2.6", ts: Date.now() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `MCorp_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click(); URL.revokeObjectURL(url);
            showNotification("Backup saved.");
        }

        function restoreData(event) {
            const file = event.target.files[0]; if(!file) return;
            showConfirmModal(
                "Restore Data", 
                "Proceeding will overwrite all existing records with the backup file. Continue?", 
                () => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if(data.employees && data.activityLog) {
                                employees = data.employees; 
                                activityLog = data.activityLog; 
                                saveData(); 
                                renderDashboard(); 
                                showNotification("Data Restored.");
                            }
                        } catch (err) { showNotification("Invalid backup file."); }
                    };
                    reader.readAsText(file);
                }
            );
        }

        function showNotification(text) {
            const div = document.createElement('div');
            div.className = "no-print fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl z-[100] font-black uppercase text-xs tracking-widest flex items-center gap-3 animate-bounce";
            div.innerHTML = `<i data-lucide="bell" class="w-4 h-4 text-blue-400"></i> ${text}`;
            document.body.appendChild(div);
            lucide.createIcons();
            setTimeout(() => div.remove(), 4000);
        }
    </script>
</body>
</html>